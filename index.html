<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Life Navigation" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="icon" href="icons/icon-192.png" />
<title>ãƒ­ã‚´ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯å®Ÿå­˜ä¸»ç¾© Life Navigation Toolkitï¼ˆå®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --card:#111f36;
      --text:#e6edf7;
      --muted:#a9b7d0;
      --line:rgba(255,255,255,.10);
      --accent:#5aa3ff;
      --accent2:#7ee0a3;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",sans-serif;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(90,163,255,.18), transparent 60%),
                  radial-gradient(900px 400px at 90% 10%, rgba(126,224,163,.14), transparent 60%),
                  linear-gradient(180deg, var(--bg), #070b13 90%);
      color:var(--text);
      min-height:100vh;
    }
    a{color:var(--accent)}
    .wrap{max-width:980px;margin:0 auto;padding:18px 16px 90px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--line);border-radius:24px;
      background: rgba(17,31,54,.65);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      position:sticky;top:12px;z-index:10;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(90,163,255,.9), rgba(126,224,163,.85));
      display:grid;place-items:center;color:#071225;font-weight:900;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .title{line-height:1.1}
    .title h1{font-size:16px;margin:0 0 2px}
    .title p{margin:0;color:var(--muted);font-size:12px}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);padding:8px 10px;border-radius:999px;
      display:flex;align-items:center;gap:8px;
    }
    .grid{display:grid;gap:14px}
    .cards{grid-template-columns: repeat(12,1fr)}
    .card{
      border:1px solid var(--line);
      background: rgba(17,31,54,.72);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 8px;font-size:18px}
    .card p{margin:0;color:var(--muted);line-height:1.7}
    .btn{
      appearance:none;border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      font-weight:700;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(90,163,255,.18);border-color: rgba(90,163,255,.45)}
    .btn.primary:hover{background: rgba(90,163,255,.24)}
    .btn.green{background: rgba(126,224,163,.16);border-color: rgba(126,224,163,.40)}
    .btn.green:hover{background: rgba(126,224,163,.22)}
    .btn.danger{background: rgba(255,107,107,.14);border-color: rgba(255,107,107,.42)}
    .btn.danger:hover{background: rgba(255,107,107,.20)}
    .btn.ghost{background: transparent}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:14px 0}
    .nav{
      position:fixed;left:0;right:0;bottom:0;
      background: rgba(9,14,25,.78);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      padding:10px 10px;
      z-index:20;
    }
    .nav .inner{max-width:980px;margin:0 auto;display:flex;gap:8px}
    .tab{
      flex:1;min-width:0;
      padding:10px 12px;border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:800;
      cursor:pointer;
      display:flex;justify-content:center;align-items:center;gap:8px;
    }
    .tab.active{
      color:var(--text);
      background: rgba(90,163,255,.18);
      border-color: rgba(90,163,255,.45);
    }
    .kpi{
      display:grid;grid-template-columns: repeat(3,1fr);gap:10px;
      margin-top:12px;
    }
    .kpi .mini{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
    }
    .mini .n{font-size:18px;font-weight:900;margin:0}
    .mini .l{font-size:12px;color:var(--muted);margin:2px 0 0}
    .stepbar{
      height:10px;border-radius:999px;background: rgba(255,255,255,.08);
      overflow:hidden;border:1px solid var(--line);
    }
    .stepbar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(90,163,255,.9), rgba(126,224,163,.85));
      transition: width .25s ease;
    }
    .stepgrid{display:grid;grid-template-columns: repeat(7,1fr);gap:8px}
    .stepbtn{
      padding:10px 8px;border-radius:14px;border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:900;
      cursor:pointer;
      text-align:center;
      line-height:1.2;
    }
    .stepbtn small{display:block;font-weight:700;color:var(--muted);opacity:.9;margin-top:4px}
    .stepbtn.active{color:var(--text);border-color: rgba(90,163,255,.45);background: rgba(90,163,255,.14)}
    .stepbtn.done{border-color: rgba(126,224,163,.38);background: rgba(126,224,163,.10)}
    textarea,input[type="text"]{
      width:100%;
      border-radius: 16px;
      padding:12px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      line-height:1.6;
    }
    textarea{min-height:110px;resize: vertical}
    label{font-size:12px;color:var(--muted);font-weight:900;display:block;margin:0 0 6px}
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:8px 10px;border-radius:999px;
      color:var(--muted);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{color:var(--text);border-color: rgba(90,163,255,.45);background: rgba(90,163,255,.14)}
    .range{
      display:flex;gap:10px;align-items:center
    }
    input[type="range"]{width:100%}
    .notice{
      border:1px solid rgba(255,204,102,.35);
      background: rgba(255,204,102,.10);
      border-radius: 18px;
      padding:12px 12px;
      color: rgba(255,235,200,.92);
      line-height:1.65;
      font-size:13px;
    }
    details{
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      padding:12px 12px;
    }
    summary{cursor:pointer;font-weight:900}
    .logcard{display:grid;gap:10px}
    .badge{
      font-size:11px;color:var(--muted);
      border:1px solid var(--line);padding:6px 8px;border-radius:999px;
      display:inline-flex;gap:8px;align-items:center;
    }
    .right{margin-left:auto}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .footerq{color:var(--muted);text-align:center;font-size:12px;margin-top:22px}
  
    /* PWA install banner */
    .installBanner{
      position: sticky;
      top: 10px;
      z-index: 50;
      margin: 10px 0 16px;
      padding: 12px 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(17,31,54,.92);
      backdrop-filter: blur(8px);
      border-radius: 14px;
      box-shadow: var(--shadow);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
    }
    .installBanner .msg{
      font-size: 13px;
      color: var(--text);
      line-height: 1.4;
    }
    .installBanner .msg b{color:#fff}
    .installBanner .actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .installBanner .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(90,163,255,.16);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 700;
      font-size: 13px;
    }
    .installBanner .btn.secondary{
      background: rgba(255,255,255,.06);
      font-weight: 600;
    }
    .installBanner.hidden{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">â›µ</div>
        <div class="title">
          <h1>ãƒ­ã‚´ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯å®Ÿå­˜ä¸»ç¾© Life Navigation Toolkit</h1>
          <p>å®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç‰ˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ãƒ»ä¿å­˜ã¯ç«¯æœ«å†…ï¼‰</p>
        </div>
      </div>
      <div class="pill" id="statusPill">ğŸŸ¢ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œ</div>
    </header>

    
    <div id="installBanner" class="installBanner hidden" role="status" aria-live="polite">
      <div class="msg" id="installMsg">
        ğŸ“² ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ <b>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </b> ã™ã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«èµ·å‹•ã§ãã¾ã™ã€‚
      </div>
      <div class="actions">
        <button class="btn" id="installBtn" type="button">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
        <button class="btn secondary" id="installHelpBtn" type="button">æ‰‹é †</button>
        <button class="btn secondary" id="installCloseBtn" type="button">Ã—</button>
      </div>
    </div>
<main id="view"></main>

    <div class="footerq">ã€Œèˆªæµ·ã¯æŠ€æ³•ã§ã¯ãªã„ã€‚é‹ç”¨ã§ã‚ã‚‹ã€‚å›è»¢æ•°ãŒã€äººç”Ÿã‚’å¤‰ãˆã‚‹ã€‚ã€</div>
  </div>

  <nav class="nav">
    <div class="inner">
      <button class="tab active" data-tab="home">ğŸ  ãƒ›ãƒ¼ãƒ </button>
      <button class="tab" data-tab="engine">ğŸ§­ ã‚¨ãƒ³ã‚¸ãƒ³</button>
      <button class="tab" data-tab="history">ğŸ“’ æ—¥èªŒ</button>
      <button class="tab" data-tab="training">ğŸ‹ï¸ è¨“ç·´</button>
      <button class="tab" data-tab="theory">ğŸ“˜ ç†è«–</button>
    </div>
  </nav>

<script>
(() => {
  const STEPS = [
    { title: 'åœèˆ¹', desc: 'ã„ã¾ã‚’å›ºå®šã™ã‚‹ã€‚æ·±å‘¼å¸ã‚’1å›ã€‚' },
    { title: 'æµ·å›³', desc: 'äº‹å®Ÿã¨è§£é‡ˆã‚’åˆ†ã‘ã‚‹ã€‚' },
    { title: 'é¢¨', desc: 'æ„Ÿæƒ…ãƒ»ä½“èª¿ã‚’ã€Œé¢¨ã€ã¨ã—ã¦èª­ã‚€ã€‚' },
    { title: 'ç¾…é‡ç›¤', desc: 'è‰¯å¿ƒï¼ˆèª å®ŸãªåŒ—ï¼‰ã‚’å•ã„ã‹ã‘ã‚‹ã€‚' },
    { title: 'æ“èˆµ', desc: '1%ã®è¡Œå‹•ã‚’ç¢ºå®šã™ã‚‹ã€‚' },
    { title: 'å®Ÿè¡Œ', desc: 'ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚»ãƒƒãƒˆã—ã¦1%ã ã‘ã€‚' },
    { title: 'æ—¥èªŒ', desc: 'å›è»¢ã‚’ä¸Šã’ã‚‹æŒ¯ã‚Šè¿”ã‚Šã€‚' }
  ];

  const WIND_TYPES = ['è™šç„¡ãƒ»ç„¡æ°—åŠ›','ä¸å®‰','æ€’ã‚Š','ç„¦ã‚Š','ç–²åŠ´','è¿·ã„','å…ˆå»¶ã°ã—','å®‰å®š'];
  const MODES = ['Aé‹ç”¨ï¼ˆè¶…å®‰å…¨ãƒ»æ•‘å‘½è‰‡ï¼‰','Bé‹ç”¨ï¼ˆæ¨™æº–ãƒ»å·¡èˆªï¼‰','Cé‹ç”¨ï¼ˆæŒ‘æˆ¦ãƒ»åŠ é€Ÿï¼‰'];


  // --- è·å ´å‘ã‘ï¼ˆå€‹äººç”¨ï¼‰ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼šæ¥­ç¨®Ã—è·ç¨®Ã—KPI/ãƒªã‚¹ã‚¯ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å†…è”µï¼‰ ---
  const INDUSTRIES = [
    'IT/ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢','è£½é€ ','åŒ»ç™‚ãƒ»ä»‹è­·','é‡‘è','å°å£²/EC','æ•™è‚²','å…¬å…±/è¡Œæ”¿','å»ºè¨­','ç‰©æµ','ã‚µãƒ¼ãƒ“ã‚¹','ãã®ä»–'
  ];
  const JOB_FUNCTIONS = [
    'å–¶æ¥­','ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆ/CS','æ¡ç”¨/äººäº‹','æ³•å‹™/ã‚³ãƒ³ãƒ—ãƒ©','è£½é€ /ç¾å ´','é–‹ç™º/ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢',
    'ãƒãƒ¼ã‚±/åºƒå ±','çµŒç†/è²¡å‹™','è³¼è²·/èª¿é”','PM/ä¼ç”»','å“è³ªä¿è¨¼/QA','ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼/ç®¡ç†è·','ãã®ä»–'
  ];

  const INDUSTRY_KPI_RISK = {
    'IT/ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢': {
      kpis: ['ARR/å£²ä¸Š','ç¶™ç¶šç‡ï¼ˆè§£ç´„ç‡ï¼‰','NPS/é¡§å®¢æº€è¶³','ç¨¼åƒç‡/å¯ç”¨æ€§','ç´æœŸéµå®ˆ','é–‹ç™ºé€Ÿåº¦/å“è³ª'],
      risks: ['æƒ…å ±æ¼ãˆã„','éšœå®³/ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ','éå‰°ãªæ®‹æ¥­ãƒ»ç‡ƒãˆå°½ã','ç‚ä¸Šï¼ˆSNS/é¡§å®¢ï¼‰','ä»•æ§˜å¤‰æ›´ã®é€£é–']
    },
    'è£½é€ ': {
      kpis: ['å“è³ªï¼ˆä¸è‰¯ç‡ï¼‰','å®‰å…¨ï¼ˆç½å®³ã‚¼ãƒ­ï¼‰','æ­©ç•™ã¾ã‚Š','ç”Ÿç”£æ€§','ç´æœŸéµå®ˆ','ã‚³ã‚¹ãƒˆ'],
      risks: ['åŠ´ç½ãƒ»å®‰å…¨äº‹æ•…','å“è³ªé€¸è„±','è¨­å‚™åœæ­¢','å½è£…ãƒ»ã‚³ãƒ³ãƒ—ãƒ©é•å','ã‚µãƒ—ãƒ©ã‚¤æ–­çµ¶']
    },
    'åŒ»ç™‚ãƒ»ä»‹è­·': {
      kpis: ['å®‰å…¨ï¼ˆäº‹æ•…ã‚¼ãƒ­ï¼‰','ã‚±ã‚¢å“è³ª','æ‚£è€…/åˆ©ç”¨è€…æº€è¶³','ç¨¼åƒï¼ˆäººå“¡é…ç½®ï¼‰','è¨˜éŒ²ã®æ­£ç¢ºæ€§'],
      risks: ['åŒ»ç™‚äº‹æ•…/ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ','è™å¾…ãƒ»å€«ç†ãƒªã‚¹ã‚¯','æ„ŸæŸ“ç—‡','é›¢è·ãƒ»ç–²å¼Š','å€‹äººæƒ…å ±æ¼ãˆã„']
    },
    'é‡‘è': {
      kpis: ['åç›Š','é¡§å®¢ç¶­æŒ','å¯©æŸ»å“è³ª','ä¸æ­£æ¤œçŸ¥','ç›£æŸ»æŒ‡æ‘˜ã‚¼ãƒ­','å•ã„åˆã‚ã›å¿œç­”å“è³ª'],
      risks: ['ä¸æ­£/è©æ¬º','ã‚³ãƒ³ãƒ—ãƒ©é•å','æƒ…å ±æ¼ãˆã„','é¢¨è©•','éåº¦ãªè²©å£²åœ§åŠ›']
    },
    'å°å£²/EC': {
      kpis: ['å£²ä¸Š','ç²—åˆ©','å›è»¢ç‡','æ¬ å“ç‡','è¿”å“ç‡','CSæº€è¶³'],
      risks: ['ã‚¯ãƒ¬ãƒ¼ãƒ ç‚ä¸Š','åœ¨åº«ä¸ä¸€è‡´','ç‰©æµé…å»¶','å€‹äººæƒ…å ±æ¼ãˆã„','ä¸æ­£æ³¨æ–‡']
    },
    'æ•™è‚²': {
      kpis: ['å­¦ç¿’æˆæœ','ç¶™ç¶šç‡','æº€è¶³åº¦','æˆæ¥­å“è³ª','é‹å–¶å®‰å®š'],
      risks: ['ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ','ç‚ä¸Š','ä¸ç™»æ ¡/é›¢è„±','å€‹äººæƒ…å ±æ¼ãˆã„','éé‡è² æ‹…']
    },
    'å…¬å…±/è¡Œæ”¿': {
      kpis: ['æ³•ä»¤éµå®ˆ','ä½æ°‘æº€è¶³','å‡¦ç†ã®æ­£ç¢ºæ€§','ç´æœŸ/æœŸé™éµå®ˆ','é€æ˜æ€§'],
      risks: ['æ‰‹ç¶šããƒŸã‚¹','æƒ…å ±æ¼ãˆã„','ä¸æ­£','ç‚ä¸Š','éé‡è² æ‹…']
    },
    'å»ºè¨­': {
      kpis: ['å®‰å…¨ï¼ˆç½å®³ã‚¼ãƒ­ï¼‰','å“è³ª','å·¥æœŸéµå®ˆ','åŸä¾¡','å”åŠ›ä¼šç¤¾é€£æº'],
      risks: ['åŠ´ç½','å·¥æœŸé…å»¶','å“è³ªä¸è‰¯','æ³•ä»¤é•å','å¤©å€™ãƒ»ç½å®³']
    },
    'ç‰©æµ': {
      kpis: ['ç´æœŸéµå®ˆ','èª¤é…é€ç‡','ç¨¼åƒç‡','ã‚³ã‚¹ãƒˆ','äº‹æ•…ã‚¼ãƒ­'],
      risks: ['äº‹æ•…','é…å»¶','éåŠ´','ã‚¯ãƒ¬ãƒ¼ãƒ ','ç›—é›£']
    },
    'ã‚µãƒ¼ãƒ“ã‚¹': {
      kpis: ['æº€è¶³åº¦','å†æ¥åº—/ç¶™ç¶š','ç”Ÿç”£æ€§','å¿œå¯¾å“è³ª','å£²ä¸Š'],
      risks: ['ã‚¯ãƒ¬ãƒ¼ãƒ ','ç‚ä¸Š','é›¢è·','ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ','éé‡è² æ‹…']
    },
    'ãã®ä»–': { kpis: ['æˆæœ','å“è³ª','æœŸé™éµå®ˆ','æº€è¶³åº¦'], risks: ['éé‡è² æ‹…','å¯¾äººæ‘©æ“¦','ç‚ä¸Š'] }
  };

  const JOB_KIND_KPI_RISK = {
    'å–¶æ¥­': { kpis: ['å•†è«‡æ•°','å—æ³¨ç‡','å£²ä¸Š','å˜ä¾¡','æ›´æ–°ç‡'], risks: ['ä¸é©åˆ‡è²©å£²','éåº¦ãªãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼','é–¢ä¿‚æ‚ªåŒ–','æƒ…å ±ç®¡ç†'] },
    'ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆ/CS': { kpis: ['ä¸€æ¬¡è§£æ±ºç‡','å¿œç­”é€Ÿåº¦','CSAT','è§£ç´„æŠ‘æ­¢'], risks: ['æ„Ÿæƒ…åŠ´åƒã®æ¶ˆè€—','ã‚¯ãƒ¬ãƒ¼ãƒ èª˜ç™º','æƒ…å ±æ¼ãˆã„','ç‡ƒãˆå°½ã'] },
    'æ¡ç”¨/äººäº‹': { kpis: ['æ¡ç”¨å……è¶³','å®šç€ç‡','ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ','åˆ¶åº¦é‹ç”¨ã®å…¬å¹³æ€§'], risks: ['ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ','ä¸å…¬å¹³æ„Ÿ','æ©Ÿå¯†æ¼ãˆã„','éé‡è² æ‹…'] },
    'æ³•å‹™/ã‚³ãƒ³ãƒ—ãƒ©': { kpis: ['ãƒªãƒ¼ã‚¬ãƒ«ãƒªã‚¹ã‚¯ä½æ¸›','å¥‘ç´„ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ','ç›£æŸ»æŒ‡æ‘˜ã‚¼ãƒ­'], risks: ['é‡å¤§é•å','ä¸æ­£','ç‚ä¸Š','å±äººåŒ–'] },
    'è£½é€ /ç¾å ´': { kpis: ['å®‰å…¨','å“è³ª','ç”Ÿç”£æ€§','æ®µå–ã‚Š'], risks: ['åŠ´ç½','ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ','æ‰‹é †é€¸è„±','ç–²åŠ´'] },
    'é–‹ç™º/ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢': { kpis: ['å“è³ª','é€Ÿåº¦','å¯ç”¨æ€§','ä¿å®ˆæ€§'], risks: ['éšœå®³','ç‡ƒãˆå°½ã','æŠ€è¡“è² å‚µ','ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£'] },
    'ãƒãƒ¼ã‚±/åºƒå ±': { kpis: ['ãƒªãƒ¼ãƒ‰','CVR','CPA','ãƒ–ãƒ©ãƒ³ãƒ‰æŒ‡æ¨™'], risks: ['ç‚ä¸Š','èª‡å¤§è¡¨ç¾','å€‹äººæƒ…å ±','ç–²å¼Š'] },
    'çµŒç†/è²¡å‹™': { kpis: ['ç· ã‚ã®æ­£ç¢ºæ€§','ã‚­ãƒ£ãƒƒã‚·ãƒ¥','ç›£æŸ»å¯¾å¿œ'], risks: ['èª¤è¨ˆä¸Š','ä¸æ­£','ç· ã‚éé‡','å±äººåŒ–'] },
    'è³¼è²·/èª¿é”': { kpis: ['ã‚³ã‚¹ãƒˆ','ç´æœŸ','å“è³ª','ä¾›çµ¦å®‰å®š'], risks: ['ã‚µãƒ—ãƒ©ã‚¤æ–­çµ¶','ä¸æ­£','å“è³ªäº‹æ•…','äº¤æ¸‰æ‘©æ“¦'] },
    'PM/ä¼ç”»': { kpis: ['ç´æœŸ','ä¾¡å€¤æä¾›','åˆæ„å½¢æˆ','ãƒªã‚¹ã‚¯ç®¡ç†'], risks: ['ä»•æ§˜çˆ†ç™º','å¯¾ç«‹','éé‡è² æ‹…','ç‚ä¸Š'] },
    'å“è³ªä¿è¨¼/QA': { kpis: ['æ¬ é™¥æµå‡ºã‚¼ãƒ­','ãƒ†ã‚¹ãƒˆç¶²ç¾…','å†ç™ºé˜²æ­¢'], risks: ['ãƒªãƒªãƒ¼ã‚¹åœ§åŠ›','è²¬ä»»éå¤š','ç‡ƒãˆå°½ã'] },
    'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼/ç®¡ç†è·': { kpis: ['ãƒãƒ¼ãƒ æˆæœ','å®šç€','è‚²æˆ','å¿ƒç†çš„å®‰å…¨æ€§'], risks: ['å­¤ç«‹','æ¿æŒŸã¿','ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ','éåŠ´'] },
    'ãã®ä»–': { kpis: [], risks: [] }
  };

  function uniq(arr){
    const s = new Set();
    const out = [];
    (arr||[]).forEach(x => { if (!x) return; const k=String(x).trim(); if(!k) return; if(!s.has(k)){s.add(k); out.push(k);} });
    return out;
  }

  function deriveKpiRisk(industry, jobFunction){
    const base = INDUSTRY_KPI_RISK[industry] || INDUSTRY_KPI_RISK['ãã®ä»–'];
    const job = JOB_KIND_KPI_RISK[jobFunction] || JOB_KIND_KPI_RISK['ãã®ä»–'];
    const kpis = uniq([...(base.kpis||[]), ...(job.kpis||[])]);
    const risks = uniq([...(base.risks||[]), ...(job.risks||[])]);
    return { kpis, risks };
  }

  function inferUserTierFromRole(role){
    const r = String(role || '').trim().toLowerCase();
    if (!r) return 'general';
    const isExec = /å½¹å“¡|å–ç· å½¹|åŸ·è¡Œ|ceo|coo|cfo|cto|ç¤¾é•·|æœ¬éƒ¨é•·|çµ±æ‹¬|vp|head/.test(r);
    if (isExec) return 'executive';
    const isMgr = /éƒ¨é•·|èª²é•·|ä¿‚é•·|ãƒãƒ|manager|lead|ãƒªãƒ¼ãƒ€|ä¸»ä»»/.test(r);
    if (isMgr) return 'manager';
    return 'general';
  }

  function resolveUserTier(){
    const t = String(state.workProfile.userTier || 'auto');
    if (t === 'auto') return inferUserTierFromRole(state.workProfile.role);
    if (t === 'executive' || t === 'manager' || t === 'general') return t;
    return 'general';
  }

  function userTierLabel(t){
    if (t === 'executive') return 'å½¹è·è€…ï¼ˆéƒ¨é•·/å½¹å“¡ï¼‰';
    if (t === 'manager') return 'ç®¡ç†è€…ï¼ˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰';
    return 'ä¸€èˆ¬ï¼ˆå€‹äºº/ç¾å ´ï¼‰';
  }

  // --- åˆ©ç”¨è€…åŒºåˆ†åˆ¥Q&Aï¼ˆè·å ´ãƒ­ã‚°ã®é‹ç”¨ãƒ’ãƒ³ãƒˆï¼‰ ---
  const TIER_FAQ_COMMON = [
    {
      q: 'Q. ä½•ã‚’æ›¸ã‘ã°ã„ã„ã‹è¿·ã„ã¾ã™ã€‚',
      a: 'A. æœ€çŸ­ã¯ã€ŒçŠ¶æ³ï¼ˆäº‹å®Ÿï¼‰â†’ 1%è¡Œå‹•ã€ã ã‘ã§OKã§ã™ã€‚ä½™åŠ›ãŒã‚ã‚Œã°ã€æ„å‘³ï¼ˆå­¦ã³ï¼‰ã¨æ…‹åº¦ï¼ˆã©ã†åœ¨ã‚‹ã‹ï¼‰ã‚’1è¡Œãšã¤è¶³ã—ã¦ãã ã•ã„ã€‚'
    },
    {
      q: 'Q. å¿™ã—ãã¦ç¶šãã¾ã›ã‚“ã€‚',
      a: 'A. 1åˆ†ã§çµ‚ã‚ã‚‹å½¢ã«è½ã¨ã—ã¾ã™ã€‚å…¨éƒ¨åŸ‹ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚â€œå®Œç’§â€ã‚ˆã‚Šâ€œç¶™ç¶šâ€ã€‚'
    },
    {
      q: 'Q. å€‹äººæƒ…å ±/æ©Ÿå¯†ãŒå¿ƒé…ã§ã™ã€‚',
      a: 'A. å€‹äººå/é¡§å®¢å/æ¡ˆä»¶åãªã©ã¯æ›¸ã‹ãšã€ã€Œé–¢ä¿‚è€…ã€ã€Œæ¡ˆä»¶ã€ã®ã‚ˆã†ã«æŠ½è±¡åŒ–ã—ã¦ãã ã•ã„ã€‚'
    },
    {
      q: 'Q. æ›¸ã„ã¦ã„ã¦ã—ã‚“ã©ããªã‚Šã¾ã™ã€‚',
      a: 'A. ä¸­æ­¢ã‚µã‚¤ãƒ³ã§ã™ã€‚æ·±å‘¼å¸â†’æ°´åˆ†â†’å®‰å…¨ãªè¡Œå‹•ã¸åˆ‡ã‚Šæ›¿ãˆã€ã€Œä»Šæ—¥ã¯ã“ã“ã¾ã§ã€ã‚‚è¨“ç·´ã€‚å¿…è¦ãªã‚‰å°‚é–€å®¶ã«ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚'
    }
  ];

  const TIER_FAQ_BY_TIER = {
    general: [
      {
        q: 'Q. ãƒã‚¬ãƒ†ã‚£ãƒ–ãªã“ã¨ã—ã‹å‡ºã¦ãã¾ã›ã‚“ã€‚',
        a: 'A. äº‹å®Ÿã¨è©•ä¾¡ã‚’åˆ†ã‘ã¾ã™ï¼ˆä½•ãŒèµ·ããŸï¼ã©ã†æ„Ÿã˜ãŸï¼‰ã€‚æ¬¡ã«ã€Œãã‚Œã§ã‚‚å®ˆã‚ŠãŸã„ä¾¡å€¤ã¯ï¼Ÿã€ã‚’1ã¤ã ã‘æ›¸ãã¨ã€æ…‹åº¦ä¾¡å€¤ãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚'
      },
      {
        q: 'Q. â€œæ„å‘³â€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚',
        a: 'A. å¤§ããªçµè«–ã§ãªãã¦OKã§ã™ã€‚ã€Œå­¦ã³ã€ã€Œæ¬¡ã«æ”¹å–„ã§ãã‚‹ç‚¹ã€ã€Œèª°ã‹ã®å½¹ã«ç«‹ã£ãŸç‚¹ã€ã‚’1ã¤è¦‹ã¤ã‘ã‚Œã°ååˆ†ã§ã™ã€‚'
      },
      {
        q: 'Q. 50%ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒæ€–ã„ã§ã™ã€‚',
        a: 'A. 50%ã¯â€œç„¡è¬€â€ã§ã¯ãªãâ€œå°ã•ãªãƒªã‚¹ã‚¯â€ã€‚å¤±æ•—ã—ã¦ã‚‚è‡´å‘½çš„ã§ãªã„ç¯„å›²ã«è¨­è¨ˆã—ã€é€±1å›ã‹ã‚‰ã«ã—ã¾ã™ã€‚'
      }
    ],
    manager: [
      {
        q: 'Q. éƒ¨ä¸‹ã«ã‚‚ã‚„ã‚‰ã›ã‚‹ã¹ãã§ã™ã‹ï¼Ÿ',
        a: 'A. å¼·åˆ¶ã¯é€†åŠ¹æœã§ã™ã€‚ã¾ãšã¯ç®¡ç†è€…ãŒè‡ªåˆ†ã®ãƒ­ã‚°ã§å®‰å…¨ãªé‹ç”¨ã‚’ç¤ºã—ã€å¸Œæœ›è€…ãŒä»»æ„ã§è©¦ã›ã‚‹å½¢ï¼ˆè©•ä¾¡ã«ä½¿ã‚ãªã„æ˜æ–‡åŒ–ï¼‰ã«ã—ã¦ãã ã•ã„ã€‚'
      },
      {
        q: 'Q. 1on1ã§ã©ã†ä½¿ãˆã°ã„ã„ã§ã™ã‹ï¼Ÿ',
        a: 'A. åŸæ–‡ãƒ­ã‚°ã®æå‡ºã¯æ±‚ã‚ãšã€ã€Œ1%è¡Œå‹•ã€ã€Œå®ˆã‚ŠãŸã„ä¾¡å€¤ã€ã€Œä¸­æ­¢ã‚µã‚¤ãƒ³ã€ã ã‘ã‚’æœ¬äººã®è¨€è‘‰ã§å…±æœ‰ã™ã‚‹æ–¹å¼ãŒå®‰å…¨ã§ã™ã€‚'
      },
      {
        q: 'Q. ä¸èª¿ã‚µã‚¤ãƒ³ãŒè¦‹ãˆãŸã‚‰ï¼Ÿ',
        a: 'A. ä¼‘æ¯/è² è·èª¿æ•´/å°‚é–€çª“å£ã¸ã¤ãªãåˆ¤æ–­ãŒæœ€å„ªå…ˆã§ã™ã€‚ãƒ­ã‚°ã¯è¨ºæ–­ã§ã¯ãªãâ€œæ°—ã¥ãã®è£œåŠ©â€ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚'
      }
    ],
    executive: [
      {
        q: 'Q. çµŒå–¶ã¨ã—ã¦ã®ä½¿ã„ã©ã“ã‚ã¯ï¼Ÿ',
        a: 'A. åŒ¿åã®å‚¾å‘ã‹ã‚‰ã€ç¾å ´ã®è©°ã¾ã‚Šï¼ˆè² è·ãƒ»ææ€–ãƒ»éå‰°é †å®ˆï¼‰ã‚’å…†å€™ã¨ã—ã¦æŠŠæ¡ã—ã€è³‡æºé…åˆ†ã‚„åˆ¶åº¦è¨­è¨ˆã®æ„æ€æ±ºå®šã«æ¥ç¶šã§ãã¾ã™ã€‚'
      },
      {
        q: 'Q. è©•ä¾¡åˆ¶åº¦ã¨æ··ãœã¦ã‚‚å¤§ä¸ˆå¤«ï¼Ÿ',
        a: 'A. åŸå‰‡ã¯åˆ†é›¢ãŒå®‰å…¨ã§ã™ã€‚è©•ä¾¡ã«ç›´çµã™ã‚‹ã¨è‡ªå·±æ¤œé–²ãŒèµ·ãã¾ã™ã€‚å¿…è¦ãªã‚‰å°‚é–€å®¶ã¨é‹ç”¨è¨­è¨ˆã‚’ã—ã¦ãã ã•ã„ã€‚'
      },
      {
        q: 'Q. å°å…¥æ™‚ã®äº‹æ•…ï¼ˆç‚ä¸Š/ä¸ä¿¡ï¼‰ã‚’é¿ã‘ã‚‹ã«ã¯ï¼Ÿ',
        a: 'A. â‘ è©•ä¾¡ã«ä½¿ã‚ãªã„ â‘¡å€‹äººæƒ…å ±ã‚’æ›¸ã‹ãªã„ â‘¢ä¸­æ­¢ã‚µã‚¤ãƒ³/ç›¸è«‡å°ç·š â‘£ãƒ‡ãƒ¼ã‚¿æœ€å°åŒ–ï¼ˆã‚¿ã‚°ä¸­å¿ƒï¼‰ã‚’æ˜æ–‡åŒ–ã—ã€ç¤¾å†…ã®è¨€ã„å›ã—ã«åˆã‚ã›ã¦åˆæ„å½¢æˆã—ã¾ã™ã€‚'
      }
    ]
  };

  function renderTierFaqHtml(){
    const eff = resolveUserTier();
    const items = [...TIER_FAQ_COMMON, ...((TIER_FAQ_BY_TIER[eff] || []) )];
    return items.map(it => `
      <details class="card" style="background:rgba(255,255,255,.03)">
        <summary><b>${esc(it.q)}</b></summary>
        <div class="sep"></div>
        <div class="muted">${esc(it.a)}</div>
      </details>
    `).join('');
  }

  const LS_LOGS = 'lde_logs_v1';
  const LS_DRAFT = 'lde_draft_v1';
  const LS_WORK_PROFILE = 'lde_work_profile_v1';

  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
  const view = $('#view');

  const state = {
    tab: 'home',
    step: 0,
    mode: 'Aé‹ç”¨ï¼ˆè¶…å®‰å…¨ãƒ»æ•‘å‘½è‰‡ï¼‰',
    draft: {
      date: '',
      mode: 'Aé‹ç”¨ï¼ˆè¶…å®‰å…¨ãƒ»æ•‘å‘½è‰‡ï¼‰',
      externalFeedback: '',
      reflection: '',
      windType: 'å®‰å®š',
      windForce: 3,
      compass: '',
      action1Percent: '',
      internalFeedback: '',
      nextStep: ''
    },
    workProfile: {
      orgName: '',
      industry: '',
      department: '',
      role: '',
      jobFunction: '',
      userTier: 'auto',
      kpiText: '',
      riskText: ''
    },
    logs: []
  };

  function nowJP() {
    try { return new Date().toLocaleString('ja-JP'); }
    catch { return new Date().toISOString(); }
  }

  function load() {
    try {
      const raw = localStorage.getItem(LS_LOGS);
      state.logs = raw ? JSON.parse(raw) : [];
    } catch { state.logs = []; }

    try {
      const raw = localStorage.getItem(LS_DRAFT);
      if (raw) state.draft = Object.assign(state.draft, JSON.parse(raw));
    } catch {}

    try {
      const raw = localStorage.getItem(LS_WORK_PROFILE);
      if (raw) state.workProfile = Object.assign(state.workProfile, JSON.parse(raw));
    } catch {}
  }

  function persistProfile(){
    localStorage.setItem(LS_WORK_PROFILE, JSON.stringify(state.workProfile));
  }

  function persist() {
    localStorage.setItem(LS_LOGS, JSON.stringify(state.logs));
  }
  function persistDraft() {
    localStorage.setItem(LS_DRAFT, JSON.stringify(state.draft));
  }

  function setTab(tab) {
    state.tab = tab;
    $$('.tab').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
    render();
  }

  function setStep(i) {
    state.step = Math.max(0, Math.min(6, i));
    persistDraft();
    render();
  }

  function resetDraft() {
    state.step = 0;
    state.draft = {
      date: '',
      mode: state.mode,
      externalFeedback: '',
      reflection: '',
      windType: 'å®‰å®š',
      windForce: 3,
      compass: '',
      action1Percent: '',
      internalFeedback: '',
      nextStep: ''
    };
    persistDraft();
  }

  function saveLog() {
    const d = state.draft;
    const id = String(Date.now());
    const entry = {
      id,
      date: d.date || nowJP(),
      mode: d.mode || state.mode,
      externalFeedback: d.externalFeedback || '',
      reflection: d.reflection || '',
      windType: d.windType || '',
      windForce: Number.isFinite(d.windForce) ? d.windForce : 0,
      compass: d.compass || '',
      action1Percent: d.action1Percent || '',
      internalFeedback: d.internalFeedback || '',
      nextStep: d.nextStep || ''
    };
    state.logs.unshift(entry);
    persist();
    resetDraft();
    alert('èˆªæµ·æ—¥èªŒã«è¨˜éŒ²ã—ã¾ã—ãŸã€‚');
    setTab('history');
  }

  function deleteLog(id) {
    if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    state.logs = state.logs.filter(x => x.id !== id);
    persist();
    render();
  }

  function deleteAllLogs() {
    if (!confirm('ã™ã¹ã¦ã®èˆªæµ·æ—¥èªŒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰')) return;
    state.logs = [];
    persist();
    render();
  }

  function exportLogs() {
    const blob = new Blob([JSON.stringify({version:1, exportedAt: nowJP(), logs: state.logs}, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'lde_logs_export.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importLogs(file) {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        const logs = Array.isArray(data.logs) ? data.logs : (Array.isArray(data) ? data : null);
        if (!logs) throw new Error('å½¢å¼ãŒä¸æ­£ã§ã™');
        // merge by id
        const map = new Map(state.logs.map(x => [x.id, x]));
        for (const e of logs) {
          if (e && e.id && !map.has(e.id)) map.set(e.id, e);
        }
        state.logs = [...map.values()].sort((a,b)=> String(b.id).localeCompare(String(a.id)));
        persist();
        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
        render();
      } catch (e) {
        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + ((e && e.message) || e));
      }
    };
    reader.readAsText(file);
  }

  function esc(s){ return ((s !== null && s !== undefined) ? s : '').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function renderHome() {
    const total = state.logs.length;
    const last = (state.logs[0] && state.logs[0].date) ? state.logs[0].date : 'æœªè¨˜éŒ²';
    const streak = calcStreak(state.logs);

    return `
      <section class="card">
        <h2>ãƒ›ãƒ¼ãƒ </h2>
        <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ <b>å®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</b> ã§å‹•ãã¾ã™ã€‚è¨˜éŒ²ã¯ã‚ãªãŸã®ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>

        <div class="kpi">
          <div class="mini"><p class="n">${total}</p><p class="l">è¨˜éŒ²æ•°</p></div>
          <div class="mini"><p class="n">${streak}</p><p class="l">é€£ç¶šæ—¥æ•°ï¼ˆç°¡æ˜“ï¼‰</p></div>
          <div class="mini"><p class="n">${esc(last)}</p><p class="l">æœ€æ–°ã®è¨˜éŒ²</p></div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn primary" id="startEngine">ğŸ§­ ã‚¨ãƒ³ã‚¸ãƒ³ã‚’å›ã™</button>
          <button class="btn ghost" id="goHistory">ğŸ“’ æ—¥èªŒã‚’è¦‹ã‚‹</button>
        </div>

        <div class="sep"></div>

        <div class="row">
          <span class="badge">âš™ï¸ é‹ç”¨ãƒ¢ãƒ¼ãƒ‰</span>
          ${MODES.map(m => `<button class="chip ${state.mode===m?'active':''}" data-mode="${esc(m)}">${esc(m.split('ï¼ˆ')[0])}</button>`).join('')}
          <span class="muted" style="font-size:12px">ï¼ˆãŠã™ã™ã‚ï¼šã¾ãšã¯Aé‹ç”¨ï¼‰</span>
        </div>

        <div class="notice" style="margin-top:12px">
          <b>ãƒ’ãƒ³ãƒˆï¼š</b>ã€Œå®Œç’§ã«è§£æ±ºã€ã§ã¯ãªãã€Œèˆªè·¯å¾©å¸°ã€ãŒç›®çš„ã§ã™ã€‚<br/>
          1%ã®èˆµï¼ˆå°ã•ãã€å®‰å…¨ã§ã€ä»Šæ—¥ã®è‡ªåˆ†ã§ã‚‚ã§ãã‚‹ï¼‰ã§å›è»¢æ•°ã‚’ä¸Šã’ã¾ã™ã€‚
        </div>
      </section>
    `;
  }

  function calcStreak(logs){
    // very simple streak: count unique dates (YYYY/MM/DD) from newest backwards
    if (!logs.length) return 0;
    const dates = logs.map(x => normalizeDateKey(x.date)).filter(Boolean);
    const uniq = [];
    for (const d of dates) if (!uniq.includes(d)) uniq.push(d);
    if (!uniq.length) return 0;
    let streak = 1;
    for (let i=1;i<uniq.length;i++){
      const prev = new Date(uniq[i-1]);
      const cur  = new Date(uniq[i]);
      const diff = Math.round((prev - cur)/(1000*60*60*24));
      if (diff===1) streak++;
      else break;
    }
    return streak;
  }
  function normalizeDateKey(s){
    // try to extract date portion and convert to YYYY-MM-DD
    if (!s) return null;
    // ISO
    const m1 = String(s).match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
    if (!m1) return null;
    const y = m1[1], mo = String(m1[2]).padStart(2,'0'), d = String(m1[3]).padStart(2,'0');
    return `${y}-${mo}-${d}`;
  }

  function renderEngine() {
    const d = state.draft;
    const pct = Math.round((state.step)/6*100);

    const stepButtons = STEPS.map((s, i) => {
      const cls = i===state.step ? 'active' : (i<state.step ? 'done' : '');
      return `<button class="stepbtn ${cls}" data-step="${i}">
        ${esc(s.title)}<small>${esc(s.desc)}</small>
      </button>`;
    }).join('');

    return `
      <section class="card">
        <div class="row">
          <h2 style="margin:0">ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆ7ã‚¹ãƒ†ãƒƒãƒ—ï¼‰</h2>
          <span class="right badge">ğŸ•° ${esc(d.date || 'æœªè¨˜éŒ²')}</span>
        </div>
        <p>ã€Œåœèˆ¹â†’æµ·å›³â†’é¢¨â†’ç¾…é‡ç›¤â†’æ“èˆµâ†’å®Ÿè¡Œâ†’æ—¥èªŒã€</p>

        <div class="stepbar" aria-label="progress"><div style="width:${pct}%"></div></div>

        <div class="sep"></div>

        <div class="stepgrid">${stepButtons}</div>

        <div class="sep"></div>

        ${renderStepBody()}

        <div class="sep"></div>

        <div class="row">
          <button class="btn" id="prevStep">â† æˆ»ã‚‹</button>
          <button class="btn primary" id="nextStep">æ¬¡ã¸ â†’</button>
          <button class="btn ghost right" id="resetDraft">ã‚„ã‚Šç›´ã™</button>
        </div>
      </section>
    `;

    function renderStepBody(){
      switch(state.step){
        case 0:
          return `
            <div class="grid">
              <div class="notice">
                <b>åœèˆ¹ï¼š</b>ã„ã¾ã‚’å›ºå®šã—ã¾ã™ã€‚æ·±å‘¼å¸ã‚’1å›ã€‚<br/>
                ã€Œã“ã®ç¬é–“ã«ç§ã¯ã€å¿œç­”ã§ãã‚‹ã€ã¨ã„ã†å‰æã«æˆ»ã‚Šã¾ã™ã€‚
              </div>
              <div class="row">
                <span class="badge">âš™ï¸ é‹ç”¨ãƒ¢ãƒ¼ãƒ‰</span>
                ${MODES.map(m => `<button class="chip ${d.mode===m?'active':''}" data-mode2="${esc(m)}">${esc(m.split('ï¼ˆ')[0])}</button>`).join('')}
              </div>
              <div>
                <label>æ—¥æ™‚ï¼ˆä»»æ„ï¼‰</label>
                <input type="text" id="dateInput" placeholder="ä¾‹ï¼š${nowJP()}" value="${esc(d.date)}" />
              </div>
              <div class="row">
                <button class="btn green" id="fillNow">ä»Šã®æ—¥æ™‚ã‚’å…¥ã‚Œã‚‹</button>
                <button class="btn primary" id="okReady">æº–å‚™OK</button>
              </div>
            </div>
          `;
        case 1:
          return `
            <div class="grid">
              <div>
                <label>å­˜åœ¨ï¼ˆä»Šæ—¥ã®ä»Šã®ç¾å®Ÿï¼‰ï¼äº‹å®Ÿï¼ˆè¦³æ¸¬ã§ãã‚‹ã‚‚ã®ï¼‰</label>
                <textarea id="ext" placeholder="ä½•ãŒèµ·ããŸï¼Ÿï¼ˆã„ã¤/ã©ã“ã§/èª°ãŒï¼‰">${esc(d.externalFeedback)}</textarea>
              </div>
              <div>
                <label>è§£é‡ˆï¼ˆé ­ã®ä¸­ã®ç‰©èªï¼‰</label>
                <textarea id="ref" placeholder="ã©ã†æ„å‘³ã¥ã‘ãŸï¼Ÿã©ã‚“ãªä¸å®‰ã‚„æ€’ã‚ŠãŒå‡ºãŸï¼Ÿ">${esc(d.reflection)}</textarea>
              </div>
              <div class="notice"><b>ã‚³ãƒ„ï¼š</b>äº‹å®Ÿã¨è§£é‡ˆãŒåˆ†ã‹ã‚ŒãŸã ã‘ã§ã€æ“èˆµã¯å§‹ã¾ã£ã¦ã„ã¾ã™ã€‚</div>
            </div>
          `;
        case 2:
          return `
            <div class="grid">
              <div>
                <label>ã„ã¾ã®ã€Œé¢¨ã€ã®ç¨®é¡</label>
                <div class="row">
                  ${WIND_TYPES.map(t => `<button class="chip ${d.windType===t?'active':''}" data-wind="${esc(t)}">${esc(t)}</button>`).join('')}
                </div>
              </div>
              <div>
                <div class="row" style="justify-content:space-between">
                  <label style="margin:0">é¢¨åŠ›ï¼ˆå¼·ã•ï¼‰ï¼š<b>${Number(d.windForce)||0}</b></label>
                  <span class="muted" style="font-size:12px">0: å‡ª ã€œ 10: åµ</span>
                </div>
                <div class="range">
                  <input type="range" min="0" max="10" value="${Number(d.windForce)||0}" id="windForce" />
                </div>
              </div>
              <div class="notice"><b>èª­ã¿æ›¿ãˆï¼š</b>æ„Ÿæƒ…ã‚„ä½“èª¿ã¯ã€Œé¢¨ã€ã€‚å¦å®šã›ãšã€èª­ã¿å–ã£ã¦èˆªè·¯èª¿æ•´ã«ä½¿ã„ã¾ã™ã€‚</div>
            </div>
          `;
        case 3:
          return `
            <div class="grid">
              <div>
                <label>ç¾…é‡ç›¤ã¸ã®æœ€çŸ­è³ªå•ï¼ˆæŠ¼ã—ã¦ã‚³ãƒ”ãƒšç”¨ï¼‰</label>
                <div class="row">
                  ${[
                    'ã„ã¾ã€æœ€ã‚‚èª å®Ÿãªä¸€æ‰‹ã¯ï¼Ÿ',
                    'ã“ã®çŠ¶æ³ã§ã€ç§ã¯èª°ã«å¯¾ã—ã¦è²¬ä»»ã‚’æŒã¡ãŸã„ï¼Ÿ',
                    '5å¹´å¾Œã®ç§ãŒèª‡ã‚Œã‚‹ã®ã¯ã©ã£ã¡ï¼Ÿ',
                    'ã“ã“ã§ç§ãŒå®ˆã‚‹ã¹ãã€Œäººé–“ã¨ã—ã¦ã®å“ä½ã€ã¯ä½•ï¼Ÿ'
                  ].map(q => `<button class="chip" data-q="${esc(q)}">${esc(q)}</button>`).join('')}
                </div>
              </div>
              <div>
                <label>ç¾…é‡ç›¤ãƒ¡ãƒ¢ï¼ˆè‰¯å¿ƒ/åŒ—ï¼‰</label>
                <textarea id="comp" placeholder="ç­”ãˆã‚„æ–¹å‘æ€§ã‚’ãƒ¡ãƒ¢...">${esc(d.compass)}</textarea>
              </div>
              <div class="notice">
                <b>ãƒã‚¤ãƒ³ãƒˆï¼š</b>ã“ã“ã§ã€Œå½“ç‚ºï¼ˆã—ãªã‘ã‚Œã°ãªã‚‰ãªã„äº‹æŸ„ï¼‰ã€ãŒæ•´ã„ã¯ã˜ã‚ã¾ã™ã€‚ã¾ã æ›–æ˜§ã§ã‚‚OKã€‚
              </div>
            </div>
          `;
        case 4:
          return `
            <div class="grid">
              <div class="notice">
                <b>ä»Šæ—¥ã®1%è¡Œå‹•ï¼ˆæœ€å°ãƒ»å®‰å…¨ãƒ»ç¢ºå®Ÿï¼‰</b><br/>
                ãƒ»æœ€å°ï¼š2ã€œ15åˆ†ã§ã§ãã‚‹ã€€ãƒ»å®‰å…¨ï¼šç”Ÿæ´»ã‚’å£Šã•ãªã„ã€€ãƒ»ç¢ºå®Ÿï¼šä»Šæ—¥ã®è‡ªåˆ†ã§ã‚‚ã§ãã‚‹
              </div>
              <div>
                <label>1%è¡Œå‹•</label>
                <textarea id="act" placeholder="ä¾‹ï¼šæœºã®ä¸Šã‚’2åˆ†ã ã‘ç‰‡ä»˜ã‘ã‚‹ / è¬ç½ªã®é€£çµ¡ã‚’ä¸€æ–‡ã ã‘æ›¸ã">${esc(d.action1Percent)}</textarea>
              </div>
              <div class="notice"><b>åˆè¨€è‘‰ï¼š</b>å®Œç’§ã‚ˆã‚Šã€Œèˆªè·¯å¾©å¸°ã€ã€‚</div>
            </div>
          `;
        case 5:
          return `
            <div class="grid">
              <div class="notice">
                <b>å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚º</b><br/>
                ã“ã“ã¯ã€Œç†å±ˆã€ã§ã¯ãªãã€Œ1%ã ã‘ã‚„ã‚‹ã€ã§ã™ã€‚ã‚¿ã‚¤ãƒãƒ¼ã‚’2ã€œ15åˆ†ã«ã€‚
              </div>
              <div class="card" style="background:rgba(255,255,255,.03)">
                <div class="row">
                  <span class="badge">ğŸ§© ä»Šæ—¥ã®1%è¡Œå‹•</span>
                </div>
                <p style="margin-top:8px;color:var(--text)"><b>${esc(d.action1Percent||'æœªå…¥åŠ›')}</b></p>
              </div>
              <div class="row">
                <button class="btn green" id="copyAction">è¡Œå‹•ã‚’ã‚³ãƒ”ãƒ¼</button>
              </div>
            </div>
          `;
        case 6:
          return `
            <div class="grid">
              <div>
                <label>å†…çš„åå¿œï¼ˆèƒ¸ã®åå¿œï¼‰</label>
                <input type="text" id="infb" placeholder="ç´å¾—/é•å’Œæ„Ÿ/ç½ªæ‚ªæ„Ÿ/èª‡ã‚Š..." value="${esc(d.internalFeedback)}" />
              </div>
              <div>
                <label>æ¬¡ã®å¾®èª¿æ•´ï¼ˆæ¬¡ã®ä¸€æ‰‹ï¼‰</label>
                <textarea id="next" placeholder="æ¬¡ã¯ã“ã†ç›´ã™ / å°‘ã—ä¸Šã’ã‚‹ / å°‘ã—ä¸‹ã’ã‚‹...">${esc(d.nextStep)}</textarea>
              </div>
              <button class="btn primary" id="saveLog">ğŸ“’ èˆªæµ·æ—¥èªŒã«è¨˜éŒ²ã—ã¦å®Œäº†</button>
              <div class="notice">
                <b>æ„å‘³ã¯è¡Œå‹•ã®ã‚ã¨ã«ç«‹ã¡ä¸ŠãŒã‚‹ã€‚</b><br/>
                ä»Šæ—¥ã®ã€Œå¿œç­”ã€ãŒã€æ¬¡ã®è‡ªåˆ†ã®èˆªè·¯ã‚’ä½œã‚Šã¾ã™ã€‚
              </div>
            </div>
          `;
      }
    }
  }

  function renderHistory() {
    if (!state.logs.length) {
      return `
        <section class="card">
          <h2>èˆªæµ·æ—¥èªŒ</h2>
          <p>èˆªæµ·æ—¥èªŒã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¨ãƒ³ã‚¸ãƒ³ã‚’å›ã—ã¦ã€æœ€åˆã®ä¸€æ­©ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†ã€‚</p>
          <div class="sep"></div>
          <button class="btn primary" id="startFromHistory">ğŸ§­ ã‚¨ãƒ³ã‚¸ãƒ³ã‚’å›ã™</button>
        </section>
      `;
    }

    const cards = state.logs.map((l) => {

      if (l && l.type === 'workplace') return `
      <details class="logcard">
        <summary>
          <span class="badge">ğŸ—“ ${esc(l.date)}</span>
          <span class="badge">ğŸ¢ è·å ´</span>
          <span class="badge">${esc(l.industry||'')}</span>
          <span class="badge">${esc(l.jobFunction||'')}</span>
          <span class="badge">${esc(l.work||'')}</span>
        </summary>
        <div class="sep"></div>
        <div class="mono" style="white-space:pre-wrap">${esc(l.body || 'â€”')}</div>
        <div class="sep"></div>
        <button class="btn danger" data-del="${esc(l.id)}">ğŸ—‘ å‰Šé™¤</button>
      </details>
      `;

      if (l && l.type === 'training') return `
      <details class="logcard">
        <summary>
          <span class="badge">ğŸ—“ ${esc(l.date)}</span>
          <span class="badge">ğŸ‹ï¸ è¨“ç·´</span>
          <span class="badge">${esc(l.pillar||'')}</span>
          <span class="badge">${esc(l.work||'')}</span>
        </summary>
        <div class="sep"></div>
        <div class="mono" style="white-space:pre-wrap">${esc(l.body || 'â€”')}</div>
        <div class="sep"></div>
        <button class="btn danger" data-del="${esc(l.id)}">ğŸ—‘ å‰Šé™¤</button>
      </details>
      `;
      return `
      <details class="logcard">
        <summary>
          <span class="badge">ğŸ—“ ${esc(l.date)}</span>
          <span class="badge">âš™ï¸ ${esc((l.mode||'').split('ï¼ˆ')[0] || 'A')}</span>
          <span class="badge">ğŸŒ¬ ${esc(l.windType||'')}</span>
          <span class="badge">ğŸ’¨ ${esc(String(((l.windForce !== null && l.windForce !== undefined) ? l.windForce : '')))}</span>
        </summary>
        <div class="sep"></div>
        <div class="grid">
          <div>
            <label>äº‹å®Ÿï¼ˆè¦³æ¸¬ï¼‰</label>
            <div class="muted">${esc(l.externalFeedback || 'â€”')}</div>
          </div>
          <div>
            <label>è§£é‡ˆï¼ˆç‰©èªï¼‰</label>
            <div class="muted">${esc(l.reflection || 'â€”')}</div>
          </div>
          <div>
            <label>ç¾…é‡ç›¤ï¼ˆè‰¯å¿ƒ/åŒ—ï¼‰</label>
            <div class="muted">ã€Œ${esc(l.compass || 'â€”')}ã€</div>
          </div>
          <div>
            <label>1%è¡Œå‹•</label>
            <div class="muted"><b>${esc(l.action1Percent || 'â€”')}</b></div>
          </div>
          <div>
            <label>å†…çš„åå¿œ</label>
            <div class="muted">${esc(l.internalFeedback || 'â€”')}</div>
          </div>
          <div>
            <label>æ¬¡ã®å¾®èª¿æ•´</label>
            <div class="muted">${esc(l.nextStep || 'â€”')}</div>
          </div>
          <div class="row">
            <button class="btn danger" data-del="${esc(l.id)}">å‰Šé™¤</button>
          </div>
        </div>
      </details>
    `;
    }).join('');

    return `
      <section class="card">
        <div class="row">
          <h2 style="margin:0">èˆªæµ·æ—¥èªŒ</h2>
          <span class="right badge">ä»¶æ•°ï¼š${state.logs.length}</span>
        </div>
        <p>ã“ã‚Œã¾ã§ã®è»Œè·¡ã¨æˆé•·ã®è¨˜éŒ²</p>
        <div class="sep"></div>

        <div class="row">
          <button class="btn primary" id="newEntry">ğŸ§­ æ–°ã—ã„è¨˜éŒ²</button>
          <button class="btn" id="export">â¬‡ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <label class="btn" style="cursor:pointer">
            â¬†ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            <input type="file" id="import" accept="application/json" style="display:none" />
          </label>
          <button class="btn danger right" id="deleteAll">ã™ã¹ã¦å‰Šé™¤</button>
        </div>

        <div class="sep"></div>

        <div class="grid">
          ${cards}
        </div>
      </section>
    `;
  }

  function renderTheory() {
    return `
      <section class="card">
        <h2>ç†è«–ï¼ˆçŸ­ãï¼‰</h2>
        <p>
          ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€Œæ„å‘³ç”Ÿæˆã‚µã‚¤ã‚¯ãƒ«ã€ã‚’ã€æ—¥ã€…ã®é‹ç”¨ã«è½ã¨ã—è¾¼ã‚“ã ã‚‚ã®ã§ã™ã€‚<br/>
          <b>è¡Œå‹•ã¯â€œçµæœâ€ã§ã¯ãªãâ€œå¿œç­”ã®å½¢æ…‹â€</b>ã§ã‚ã‚Šã€æ„å‘³ã¯è¡Œå‹•ã®ã‚ã¨ã«ç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚
        </p>

        <div class="sep"></div>

        <div class="grid">
          <div class="card" style="background:rgba(255,255,255,.03)">
            <h2 style="font-size:16px;margin-bottom:6px">è‡ªå·±æ ¡æ­£ã™ã‚‹æ„å‘³ç”Ÿæˆã‚µã‚¤ã‚¯ãƒ«</h2>
            <p>å°ã•ãå›ã™ã»ã©ã€è§£é‡ˆï¼ˆç‰©èªï¼‰ã¨å½“ç‚ºï¼ˆã—ãªã‘ã‚Œã°ãªã‚‰ãªã„äº‹æŸ„ï¼‰ãŒè‡ªç„¶ã«æ´—ç·´ã•ã‚Œã¦ã„ãã¾ã™ã€‚</p>
          </div>

          <div class="card" style="background:rgba(255,255,255,.03)">
            <h2 style="font-size:16px;margin-bottom:6px">åˆæœŸå€¤éä¾å­˜</h2>
            <p>ã¯ã˜ã‚ã®ä¾¡å€¤è¦³ã‚„æ°—åˆ†ãŒã©ã‚“ãªçŠ¶æ…‹ã§ã‚‚ã€ã€Œ1%è¡Œå‹•ã€ã«ã‚ˆã£ã¦å›è»¢ãŒå§‹ã¾ã‚‹è¨­è¨ˆã§ã™ã€‚</p>
          </div>

          <div class="card" style="background:rgba(255,255,255,.03)">
            <h2 style="font-size:16px;margin-bottom:6px">å¯é€†æ€§ã®æ‹…ä¿</h2>
            <p>å¤§ããªæ±ºæ–­ã‚’é¿ã‘ã€å¾®èª¿æ•´ã§èˆªè·¯å¾©å¸°ã™ã‚‹ã€‚ã ã‹ã‚‰å®‰å…¨ã«ç¶šã‘ã‚‰ã‚Œã¾ã™ã€‚</p>
          </div>

          <div class="card" style="background:rgba(255,255,255,.03)">
            <h2 style="font-size:16px;margin-bottom:6px">å½“ç‚ºï¼ˆã—ãªã‘ã‚Œã°ãªã‚‰ãªã„äº‹æŸ„ï¼‰ã®æ´—ç·´</h2>
            <p>ç¾…é‡ç›¤ï¼ˆè‰¯å¿ƒï¼‰ã¸ã®å•ã„ã‚’é€šã—ã¦ã€Œæ¬¡ã«ä½•ã‚’å®ˆã‚ŠãŸã„ã‹ã€ãŒã‚¯ãƒªã‚¢ã«ãªã£ã¦ã„ãã¾ã™ã€‚</p>
          </div>

          <div class="notice">
            <b>è‡¨åºŠçš„ãªæ³¨æ„ç‚¹ã«ã¤ã„ã¦</b><br/>
            æœ¬ã‚¨ãƒ³ã‚¸ãƒ³ã¯ã€å¼·ã„ç²¾ç¥ç—…æ€§ç—‡çŠ¶ï¼ˆå¹»è¦šãƒ»å¦„æƒ³ãªã©ï¼‰ãŒã‚ã‚‹å ´åˆã€è‡ªå·±åˆ¤æ–­ã§ã®é‹ç”¨ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚<br/>
            ç²¾ç¥çš„ãªç—‡çŠ¶ãŒã‚ã‚‹å ´åˆã¯ã€å°‚é–€å®¶ã®æ²»ç™‚ãƒ»æ”¯æ´ã‚’å„ªå…ˆã—ã€å®‰å®šå¾Œã«ã€Œç”Ÿæ´»åŸºç›¤ã®æ•´å‚™ï¼ˆAé‹ç”¨ï¼‰ã€ã¨ã—ã¦è£œåŠ©çš„ã«ç”¨ã„ã‚‹ã“ã¨ãŒå®‰å…¨ã§ã™ã€‚
          </div>
        </div>
      </section>
    `;
  }

  
  function renderTraining() {
    let today = '';
    try { today = new Date().toISOString().slice(0,10); } catch { today = ''; }

    return `
      <section class="card">
        <h2>ğŸ‹ï¸ è¨“ç·´ï¼ˆãƒ¯ãƒ¼ã‚¯å…¥åŠ›ï¼‰</h2>
        <p class="muted">
          ã“ã®ç”»é¢ã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã®è¨“ç·´ã‚’ã€Œãƒ•ã‚©ãƒ¼ãƒ åŒ–ã€ã—ãŸã‚‚ã®ã§ã™ã€‚å…¥åŠ›å†…å®¹ã¯ãƒãƒƒãƒˆé€ä¿¡ã›ãšã€ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
          è¨˜éŒ²ã™ã‚‹ã¨ã€ŒğŸ“’ æ—¥èªŒã€ã«å…¥ã‚Šã¾ã™ã€‚
        </p>
        <div class="sep"></div>
        <div class="muted">â€»é‡ã„è¨“ç·´ï¼ˆæœ€æ‚ªæƒ³å®šãªã©ï¼‰ã¯ã€å¿ƒèº«ãŒå®‰å®šã—ã¦ã„ã‚‹ã¨ãã ã‘ãƒ»ç„¡ç†ã‚’ã—ãªã„ã§ãã ã•ã„ã€‚</div>
      </section>

      <details class="card" open>
        <summary><b>ç¬¬ä¸€ã®æŸ±ï¼šè‡ªå·±è¶…è¶Š å¼·åŒ–è¨“ç·´</b></summary>
        <div class="sep"></div>

        <details class="card">
          <summary>1.1 ä¸€æ—¥ä¸€å–„ï¼šåˆ©ä»–çš„è¡Œå‹•</summary>
          <div class="sep"></div>
          <form data-training data-pillar="ç¬¬ä¸€ã®æŸ±" data-work="1.1 ä¸€æ—¥ä¸€å–„">
            <div class="grid">
              <div>
                <label>æ—¥ä»˜</label>
                <input type="date" name="æ—¥ä»˜" value="${today}">
              </div>
              <div>
                <label>å®Ÿè·µã—ãŸåˆ©ä»–çš„è¡Œå‹•</label>
                <input name="åˆ©ä»–çš„è¡Œå‹•" placeholder="ä¾‹ï¼šå¸­ã‚’è­²ã£ãŸï¼å£°ã‚’ã‹ã‘ãŸï¼å°ã•ãªæ‰‹åŠ©ã‘">
              </div>
            </div>
            <label>è¡Œå‹•ä¸­ã®æ°—æŒã¡</label>
            <textarea name="è¡Œå‹•ä¸­ã®æ°—æŒã¡" rows="3" placeholder="ä¾‹ï¼šæœ€åˆã¯å°‘ã—ç…§ã‚ŒãŸï¼å¿ƒãŒæ¸©ã‹ããªã£ãŸ"></textarea>
            <label>å¾—ã‚‰ã‚ŒãŸæ°—ã¥ã</label>
            <textarea name="å¾—ã‚‰ã‚ŒãŸæ°—ã¥ã" rows="3" placeholder="ä¾‹ï¼šæ„è­˜ãŒè‡ªåˆ†ã®å¤–ã«å‘ãã¨ã€æ‚©ã¿ãŒç›¸å¯¾åŒ–ã—ãŸ"></textarea>
            <div class="sep"></div>
            <button class="btn primary" type="submit">ğŸ“’ æ—¥èªŒã«è¨˜éŒ²</button>
          </form>
        </details>

        <details class="card">
          <summary>1.2 è‡ªå·±è¶…è¶Šæ€è€ƒè¨“ç·´ï¼šè‡ªåˆ†ä»¥å¤–ã®ã‚‚ã®ã‚’å¿—å‘ã™ã‚‹</summary>
          <div class="sep"></div>
          <form data-training data-pillar="ç¬¬ä¸€ã®æŸ±" data-work="1.2 è‡ªå·±è¶…è¶Šæ€è€ƒè¨“ç·´">
            <label>ç§ãŒå¿ƒã‹ã‚‰è²¢çŒ®ã—ãŸã„ç¤¾ä¼šå•é¡Œã‚„å¤§ç¾©ã¯ï¼Ÿ</label>
            <textarea name="å¤§ç¾©" rows="3"></textarea>
            <label>ç§ãŒæ™‚é–“ã‚’å¿˜ã‚Œã¦æ²¡é ­ã§ãã‚‹ç†æƒ³ã‚„ä¾¡å€¤è¦³ã¯ï¼Ÿ</label>
            <textarea name="ç†æƒ³ãƒ»ä¾¡å€¤è¦³" rows="3"></textarea>
            <label>ç§ãŒå®ˆã‚ŠãŸã„ï¼å‰µé€ ã—ãŸã„ç¾ã—ã„ã‚‚ã®ã¯ï¼Ÿï¼ˆè‡ªç„¶ãƒ»èŠ¸è¡“ãƒ»é–¢ä¿‚ãªã©ï¼‰</label>
            <textarea name="ç¾ã—ã„ã‚‚ã®" rows="3"></textarea>
            <label>ç§ã®çŸ¥è­˜ã‚„çµŒé¨“ã¯ã€èª°ã‹ï¼ä½•ã‹ã®ãŸã‚ã«ã©ã†å½¹ç«‹ã¦ã‚‰ã‚Œã‚‹ï¼Ÿ</label>
            <textarea name="å½¹ç«‹ã¦æ–¹" rows="3"></textarea>
            <div class="sep"></div>
            <button class="btn primary" type="submit">ğŸ“’ æ—¥èªŒã«è¨˜éŒ²</button>
          </form>
        </details>

        <details class="card">
          <summary>1.3 æ†§ã‚Œã®äººç‰©ã‹ã‚‰å­¦ã¶è¨“ç·´</summary>
          <div class="sep"></div>
          <form data-training data-pillar="ç¬¬ä¸€ã®æŸ±" data-work="1.3 æ†§ã‚Œã®äººç‰©">
            <label>æ†§ã‚Œã®äººç‰©ï¼ˆ1äººï¼‰</label>
            <input name="äººç‰©å" placeholder="ä¾‹ï¼šèº«è¿‘ãªå…ˆè¼©ï¼æ­´å²ä¸Šã®äººç‰©ï¼è‘—è€…ãªã©">
            <label>ãã®äººç‰©ã®ã€ã©ã‚“ãªä¾¡å€¤è¦³ãƒ»ä¿¡å¿µã«æƒ¹ã‹ã‚Œã‚‹ï¼Ÿ</label>
            <textarea name="æƒ¹ã‹ã‚Œã‚‹ç‚¹" rows="3"></textarea>
            <label>ãã®äººç‰©ãŒè¿½æ±‚ã—ãŸã€Œæ„å‘³ï¼ä½¿å‘½ã€ã¯ä½•ã ã¨æ€ã†ï¼Ÿ</label>
            <textarea name="æ„å‘³ãƒ»ä½¿å‘½" rows="3"></textarea>
            <label>å›°é›£ãªçŠ¶æ³ã§ã€ãã®äººãªã‚‰ã©ã†è€ƒãˆã©ã†è¡Œå‹•ã™ã‚‹ï¼Ÿ</label>
            <textarea name="å›°é›£æ™‚ã®è¡Œå‹•" rows="3"></textarea>
            <label>è‡ªåˆ†ã®äººç”Ÿã§å®Ÿè·µã—ãŸã„ã“ã¨ï¼ˆå…·ä½“çš„ã«ï¼‰</label>
            <textarea name="å®Ÿè·µã—ãŸã„ã“ã¨" rows="3"></textarea>
            <div class="sep"></div>
            <button class="btn primary" type="submit">ğŸ“’ æ—¥èªŒã«è¨˜éŒ²</button>
          </form>
        </details>
      </details>

      <details class="card">
        <summary><b>ç¬¬äºŒã®æŸ±ï¼šæ„å‘³ç™ºè¦‹ å¼·åŒ–è¨“ç·´</b></summary>
        <div class="sep"></div>

        <details class="card">
          <summary>2.1 ã‚¸ãƒ£ãƒ¼ãƒŠãƒªãƒ³ã‚°ï¼šçµŒé¨“ã‹ã‚‰ã€Œæ„å‘³ã€ã‚’æŠ½å‡º</summary>
          <div class="sep"></div>
          <form data-training data-pillar="ç¬¬äºŒã®æŸ±" data-work="2.1 ã‚¸ãƒ£ãƒ¼ãƒŠãƒªãƒ³ã‚°">
            <label>ä»Šæ—¥ï¼ˆä»Šé€±ï¼‰ã®çµŒé¨“ã‹ã‚‰å­¦ã‚“ã ã€æœ€ã‚‚é‡è¦ãªã“ã¨ã¯ï¼Ÿ</label>
            <textarea name="å­¦ã³" rows="3"></textarea>
            <label>æœ€è¿‘ã®å›°é›£ãŒã€é•·æœŸçš„ã«ã©ã‚“ãªæˆé•·ã‚„æ„å‘³ã‚’ã‚‚ãŸã‚‰ã™å¯èƒ½æ€§ãŒã‚ã‚‹ï¼Ÿ</label>
            <textarea name="å›°é›£ã®æ„å‘³" rows="3"></textarea>
            <label>æœ€è¿‘ã®å–œã³ï¼æ„Ÿå‹•ã¯ã€ã©ã‚“ãªä¾¡å€¤ã‚’ç¤ºã—ã¦ã„ã‚‹ï¼Ÿ</label>
            <textarea name="å–œã³ã®ä¾¡å€¤" rows="3"></textarea>
            <label>ã“ã®çµŒé¨“ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä»˜ã‘ã‚‹ãªã‚‰ï¼Ÿ</label>
            <input name="ã‚¿ã‚¤ãƒˆãƒ«" placeholder="ä¾‹ï¼šã€é€†é¢¨ã®ä¸­ã®ä¸€æ­©ã€">
            <div class="sep"></div>
            <button class="btn primary" type="submit">ğŸ“’ æ—¥èªŒã«è¨˜éŒ²</button>
          </form>
        </details>

        <details class="card">
          <summary>2.2 ãƒ¡ã‚¿èªçŸ¥çš„æ—¥èªŒï¼šè¡å‹•ã¨æ„å‘³ã®ã‚ã„ã ã«ã€Œé–“ã€ã‚’ã¤ãã‚‹</summary>
          <div class="sep"></div>
          <form data-training data-pillar="ç¬¬äºŒã®æŸ±" data-work="2.2 ãƒ¡ã‚¿èªçŸ¥çš„æ—¥èªŒï¼ˆ1å›åˆ†ï¼‰">
            <label>çŠ¶æ³ï¼šä»Šã©ã“ã§ã€ä½•ãŒèµ·ãã¦ã„ã‚‹ï¼Ÿ</label>
            <textarea name="çŠ¶æ³" rows="2"></textarea>
            <label>æ„Ÿæƒ…ãƒ»èº«ä½“æ„Ÿè¦šï¼šã„ã¡ã°ã‚“å¼·ã„ã‚‚ã®</label>
            <textarea name="æ„Ÿæƒ…ãƒ»èº«ä½“æ„Ÿè¦š" rows="2" placeholder="ä¾‹ï¼šä¸å®‰7/10ã€èƒ¸ãŒã–ã‚ã–ã‚"></textarea>
            <label>æµ®ã‹ã‚“ã§ã„ã‚‹è€ƒãˆãƒ»ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</label>
            <textarea name="è€ƒãˆãƒ»ã‚¹ãƒˆãƒ¼ãƒªãƒ¼" rows="2" placeholder="ä¾‹ï¼šã€ã©ã†ã›ç„¡ç†ã ã€"></textarea>
            <label>è¡Œå‹•ã—ãŸããªã‚‹è¡å‹•ï¼æ„å‘³ã«é©ã£ãŸé¸æŠ</label>
            <textarea name="è¡å‹•ã¨é¸æŠ" rows="3" placeholder="ä¾‹ï¼šã™ãè¿”ä¿¡ã—ãŸã„â†’5åˆ†ç½®ã„ã¦è½ã¡ç€ã„ã¦è¿”ã™"></textarea>
            <div class="sep"></div>
            <button class="btn primary" type="submit">ğŸ“’ æ—¥èªŒã«è¨˜éŒ²</button>
          </form>
        </details>

        <details class="card">
          <summary>2.4 æ„Ÿè¬ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼šä»Šæ—¥ã®æ„Ÿè¬3ã¤</summary>
          <div class="sep"></div>
          <form data-training data-pillar="ç¬¬äºŒã®æŸ±" data-work="2.4 æ„Ÿè¬ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«">
            <label>æ„Ÿè¬â‘ ï¼ˆãªãœä¾¡å€¤ãŒã‚ã‚‹ï¼Ÿï¼‰</label>
            <textarea name="æ„Ÿè¬1" rows="2"></textarea>
            <label>æ„Ÿè¬â‘¡ï¼ˆãªãœä¾¡å€¤ãŒã‚ã‚‹ï¼Ÿï¼‰</label>
            <textarea name="æ„Ÿè¬2" rows="2"></textarea>
            <label>æ„Ÿè¬â‘¢ï¼ˆãªãœä¾¡å€¤ãŒã‚ã‚‹ï¼Ÿï¼‰</label>
            <textarea name="æ„Ÿè¬3" rows="2"></textarea>
            <div class="sep"></div>
            <button class="btn primary" type="submit">ğŸ“’ æ—¥èªŒã«è¨˜éŒ²</button>
          </form>
        </details>
      </details>

      <details class="card">
        <summary><b>ç¬¬ä¸‰ã®æŸ±ï¼šæ…‹åº¦ä¾¡å€¤ï¼ç²¾ç¥ã®ç­‹åŠ› å¼·åŒ–è¨“ç·´</b></summary>
        <div class="sep"></div>

        <details class="card">
          <summary>50ï¼…å‹‡æ°—ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆå°ã•ãªãƒªã‚¹ã‚¯ã‚’å–ã‚‹è¨“ç·´ï¼‰</summary>
          <div class="sep"></div>
          <div class="muted">â€»å¤§ããªäººç”Ÿæ±ºæ–­ã«ã¯ä½¿ã‚ãšã€ã€Œå°ã•ãªæŒ‘æˆ¦ã€ã§ç­‹åŠ›ã‚’é›ãˆã‚‹ãŸã‚ã®ãƒ¯ãƒ¼ã‚¯ã€‚</div>
          <div class="sep"></div>
          <form data-training data-pillar="ç¬¬ä¸‰ã®æŸ±" data-work="50ï¼…å‹‡æ°—ãƒãƒ£ãƒ¬ãƒ³ã‚¸">
            <label>ãƒãƒ£ãƒ¬ãƒ³ã‚¸å†…å®¹ï¼ˆä½•ã‚’ã‚„ã£ã¦ã¿ã‚‹ï¼Ÿï¼‰</label>
            <textarea name="ãƒãƒ£ãƒ¬ãƒ³ã‚¸å†…å®¹" rows="2"></textarea>
            <label>æ„å‘³ã®ã‚ã‚‹ä¸€æ­©ã ã¨æ€ã†ç†ç”±</label>
            <textarea name="ç†ç”±" rows="2"></textarea>
            <label>æˆåŠŸç¢ºç‡ï¼ˆæ„Ÿè¦šã§OKï¼‰</label>
            <input name="æˆåŠŸç¢ºç‡" placeholder="ä¾‹ï¼š50ï¼…å‰å¾Œ">
            <label>ã¤ãªãŒã£ã¦ã„ã‚‹ä¾¡å€¤ãƒ»å½“ç‚ºï¼ˆã—ãªã‘ã‚Œã°ãªã‚‰ãªã„äº‹æŸ„ï¼Sollenï¼‰</label>
            <textarea name="ä¾¡å€¤ãƒ»å½“ç‚º" rows="2"></textarea>
            <div class="sep"></div>
            <label>å®Ÿè¡Œå¾Œï¼šçµæœï¼ˆäº‹å®Ÿãƒ¬ãƒ™ãƒ«ï¼‰</label>
            <textarea name="çµæœ" rows="2"></textarea>
            <label>æœ€åˆã«æµ®ã‹ã‚“ã æ„Ÿæƒ…ãƒ»è©•ä¾¡</label>
            <textarea name="æ„Ÿæƒ…ãƒ»è©•ä¾¡" rows="2"></textarea>
            <label>äº‹å¾Œçš„è‡ªç”±ï¼šå­¦ã³ï¼ç­‹åŠ›ãŒã©ã†é›ãˆã‚‰ã‚ŒãŸï¼Ÿ</label>
            <textarea name="äº‹å¾Œçš„è‡ªç”±ã®å†è§£é‡ˆ" rows="3"></textarea>
            <label>æ¬¡ã®å°ã•ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸æ¡ˆ</label>
            <textarea name="æ¬¡ã®æ¡ˆ" rows="2"></textarea>
            <div class="sep"></div>
            <button class="btn primary" type="submit">ğŸ“’ æ—¥èªŒã«è¨˜éŒ²</button>
          </form>
        </details>

        <details class="card">
          <summary>3.1 ãƒ¦ãƒ¼ãƒ¢ã‚¢ã®è¨“ç·´ï¼ˆçŠ¶æ³ã‹ã‚‰è‡ªåˆ†ã‚’å¼•ãé›¢ã™ï¼‰</summary>
          <div class="sep"></div>
          <form data-training data-pillar="ç¬¬ä¸‰ã®æŸ±" data-work="3.1 ãƒ¦ãƒ¼ãƒ¢ã‚¢ã®è¨“ç·´">
            <label>æœ€è¿‘ã®å°ã•ãªå¤±æ•—ï¼ã‚¹ãƒˆãƒ¬ã‚¹å‡ºæ¥äº‹</label>
            <textarea name="å‡ºæ¥äº‹" rows="2"></textarea>
            <label>ãã‚Œã‚’ã‚³ãƒ¡ãƒ‡ã‚£æ˜ ç”»ã®ãƒ¯ãƒ³ã‚·ãƒ¼ãƒ³ã¨ã—ã¦è¦‹ã‚‹ã¨ï¼Ÿï¼ˆæ»‘ç¨½ãªç‚¹ãƒ»çš®è‚‰ãªç‚¹ï¼‰</label>
            <textarea name="ãƒ¦ãƒ¼ãƒ¢ã‚¢è¦–ç‚¹" rows="3"></textarea>
            <div class="sep"></div>
            <button class="btn primary" type="submit">ğŸ“’ æ—¥èªŒã«è¨˜éŒ²</button>
          </form>
        </details>

<details class="card">
  <summary>3.2 çµ¶æœ›çš„çŠ¶æ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ…‹åº¦å¤‰å®¹ï¼‰</summary>
  <div class="sep"></div>
  <div class="notice">
    <b>è­¦å‘Šï¼š</b>ã“ã®è¨“ç·´ã¯å¿ƒã«å¤§ããªè² è·ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã”è‡ªèº«ã®å¿ƒèº«ãŒå®‰å®šã—ã¦ã„ã‚‹æ™‚ã«å–ã‚Šçµ„ã¿ã€éåº¦ãªã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ãŸå ´åˆã¯æ±ºã—ã¦ç„¡ç†ã‚’ã›ãšã€å°‚é–€å®¶ã¸ã®ç›¸è«‡ã‚‚æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
  </div>
  <div class="sep"></div>
  <div class="muted">
    <b>ç‹™ã„ï¼š</b>ã‚ãˆã¦æœ€æ‚ªã®çŠ¶æ³ã‚’æƒ³åƒã™ã‚‹ã€Œé€†èª¬çš„ã€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’é€šã—ã¦ã€æ¥µé™çŠ¶æ³ã§ã‚‚å¤±ã‚ã‚Œãªã„ã€Œæ…‹åº¦ä¾¡å€¤ã€ã‚’è¦‹å‡ºã—ã€ç²¾ç¥çš„ãªå…ç–«ï¼ˆè€æ€§ï¼‰ã‚’é¤Šã„ã¾ã™ã€‚æš—é—‡ã‚’ç›´è¦–ã—ã¦ã€ãã®ä¸­ã«ã•ãˆæ¶ˆãˆãªã„å…‰ã‚’è¦‹å‡ºã™ãŸã‚ã®â€œå¿ƒã®æº–å‚™â€ã§ã™ã€‚
  </div>
  <div class="sep"></div>
  <form data-training data-pillar="ç¬¬ä¸‰ã®æŸ±" data-work="3.2 çµ¶æœ›çš„çŠ¶æ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³">
    <label>æ—¥ä»˜</label>
    <input type="date" name="æ—¥ä»˜" value="${today}">
    <label>ãƒ†ãƒ¼ãƒï¼ˆæœ€æ‚ªã®æƒ³å®šï¼‰</label>
    <textarea name="ãƒ†ãƒ¼ãƒ" rows="2">ã‚‚ã—è‡ªåˆ†ãŒã€ä»•äº‹ã€è²¡ç”£ã€äººé–“é–¢ä¿‚ãªã©ã€å¤§åˆ‡ã«ã—ã¦ã„ã‚‹å…¨ã¦ã‚’å¤±ã£ãŸã‚‰ï¼Ÿ</textarea>
    <label>â‘ ãã®çŠ¶æ³ã§ã€é¸ã¹ã‚‹ã€Œæ…‹åº¦ã€ã¯ï¼Ÿï¼ˆä¾‹ï¼šå°Šå³ã‚’ä¿ã¤ï¼å¸Œæœ›ã‚’æ¨ã¦ãªã„ï¼ä»–è€…ã¸ã®å„ªã—ã•ã‚’å¿˜ã‚Œãªã„â€¦ï¼‰</label>
    <textarea name="æ…‹åº¦" rows="3" placeholder="ä¾‹ï¼šã€ä¸å®‰ã®ä¸­ã§ã‚‚ã€ä»–è€…ã¸ã®ç¤¼ç¯€ã¯å®ˆã‚‹ã€"></textarea>
    <label>â‘¡ãã®æ…‹åº¦ã‚’é¸ã¶ã“ã¨è‡ªä½“ã«ã€ã©ã®ã‚ˆã†ãªã€Œæ„å‘³ã€ã‚’è¦‹å‡ºã›ã‚‹ï¼Ÿ</label>
    <textarea name="æ„å‘³" rows="3" placeholder="ä¾‹ï¼šã€æ¡ä»¶ãŒå´©ã‚Œã¦ã‚‚ã€è‡ªåˆ†ã®æ ¸ã¯å®ˆã‚Œã‚‹ã€"></textarea>
    <label>â‘¢ãã‚Œã§ã‚‚ãªãŠæ®‹ã•ã‚Œã¦ã„ã‚‹ä¾¡å€¤ï¼ˆå‰µé€ ä¾¡å€¤ï¼ä½“é¨“ä¾¡å€¤ãªã©ï¼‰ã®å¯èƒ½æ€§ã¯ï¼Ÿ</label>
    <textarea name="æ®‹ã‚‹ä¾¡å€¤" rows="3" placeholder="ä¾‹ï¼šã€èª°ã‹ã‚’æ”¯ãˆã‚‹ä¸€è¨€ã€ã€å­¦ã³ç›´ã—ã€ã€è‡ªç„¶ã®ç¾ã—ã•ã€"></textarea>
    <label>ä»Šã®è‡ªåˆ†ã¸ã®ä¸€è¨€ï¼ˆæ…ˆã—ã¿ãƒ»åŠ±ã¾ã—ï¼‰</label>
    <textarea name="è‡ªåˆ†ã¸ã®ä¸€è¨€" rows="2" placeholder="ä¾‹ï¼šã€ã‚†ã£ãã‚Šã§ã„ã„ã€‚ä»Šæ—¥ã§ãã‚‹1%ã‹ã‚‰ã€"></textarea>
    <label>ä¸­æ­¢ã‚µã‚¤ãƒ³ï¼ˆä½“ã®åå¿œï¼‰â€»å‡ºãŸã‚‰ä¸­æ–­</label>
    <textarea name="ä¸­æ­¢ã‚µã‚¤ãƒ³ï¼ˆä½“ã®åå¿œï¼‰" rows="2" placeholder="ä¾‹ï¼šå‹•æ‚¸ï¼å‘¼å¸ãŒæµ…ã„ï¼é ­ç—›ï¼åãæ°—ï¼æ¶™ãŒæ­¢ã¾ã‚‰ãªã„ï¼æ‰‹ãŒéœ‡ãˆã‚‹â€¦"></textarea>
    <label>ç¾å®Ÿã§ã®1%è¡Œå‹•ï¼ˆå‚™ãˆï¼‰â€»â€œç€åœ°â€ã®ãŸã‚ã®å°ã•ãªä¸€æ­©</label>
    <textarea name="ç¾å®Ÿã§ã®1%è¡Œå‹•ï¼ˆå‚™ãˆï¼‰" rows="2" placeholder="ä¾‹ï¼šä¿¡é ¼ã§ãã‚‹äººã«é€£çµ¡ï¼ä¼‘æ¯ã‚’ç¢ºä¿ï¼ç›¸è«‡å…ˆãƒ¡ãƒ¢ä½œæˆï¼å®¶è¨ˆã®è¦‹ç›´ã—5åˆ†â€¦"></textarea>
    <div class="muted">â€»ä¸­æ­¢ã‚µã‚¤ãƒ³ãŒå‡ºãŸã‚‰ã€æ·±å‘¼å¸â†’æ°´åˆ†è£œçµ¦â†’å®‰å…¨ãªæ´»å‹•ã¸åˆ‡ã‚Šæ›¿ãˆã€‚å¿…è¦ãªã‚‰å°‚é–€å®¶ã«ç›¸è«‡ã€‚</div>
    <div class="sep"></div>
    <button class="btn primary" type="submit">ğŸ“’ æ—¥èªŒã«è¨˜éŒ²</button>
  </form>
</details>

        <details class="card">
          <summary>3.3 ä¾¡å€¤ã®ç›¸å¯¾åŒ–ï¼ˆä¾å­˜ã‚’æ‰‹æ”¾ã™ï¼‰</summary>
          <div class="sep"></div>
          <form data-training data-pillar="ç¬¬ä¸‰ã®æŸ±" data-work="3.3 ä¾¡å€¤ã®ç›¸å¯¾åŒ–">
            <label>ã€Œã“ã‚Œã ã‘ã¯å¤±ã„ãŸããªã„ã€ä¾¡å€¤â‘ </label>
            <input name="çµ¶å¯¾ä¾¡å€¤1">
            <label>ä¾¡å€¤â‘¡</label>
            <input name="çµ¶å¯¾ä¾¡å€¤2">
            <label>ä¾¡å€¤â‘¢</label>
            <input name="çµ¶å¯¾ä¾¡å€¤3">
            <label>ãã®ã†ã¡1ã¤ã‚’å¤±ã£ãŸã¨ä»®å®šã—ãŸã¨ãã€ãªãŠè¦‹å‡ºã—ã†ã‚‹ä»–ã®æ„å‘³ï¼ä¾¡å€¤ã¯ï¼Ÿ</label>
            <textarea name="ä»£æ›¿ã®æ„å‘³ãƒ»ä¾¡å€¤" rows="3"></textarea>
            <div class="sep"></div>
            <button class="btn primary" type="submit">ğŸ“’ æ—¥èªŒã«è¨˜éŒ²</button>
          </form>
        </details>
      </details>

      <details class="card" open>
        <summary><b>ğŸ¢ è·å ´å‘ã‘ï¼ˆå€‹äººã§ä½¿ã†ï¼‰è¶…ç²¾å¯†ãƒ†ãƒ³ãƒ—ãƒ¬ï¼šæ¥­ç¨®Ã—è·ç¨®Ã—KPI/ãƒªã‚¹ã‚¯</b></summary>
        <div class="sep"></div>
        <div class="muted">
          ã€Œä¼æ¥­å°å…¥ç‰ˆã€ã§ä½¿ã£ã¦ã„ã‚‹ç™ºæƒ³ã‚’ã€<b>å€‹äººã®è·å ´é‹ç”¨</b>ã«è½ã¨ã—è¾¼ã‚“ã ãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚<br/>
          ç›®çš„ã¯â€œè©•ä¾¡â€ã§ã¯ãªãã€<b>KPIã‚’ã€Œå®ˆã‚‹å¯¾è±¡ï¼ˆä¾¡å€¤ï¼‰ã€ã¸ç¿»è¨³ã—ã¦ã€ç²¾ç¥ã®ç­‹åŠ›ï¼ˆæ…‹åº¦ä¾¡å€¤ï¼‰ã§å›ã™</b>ã“ã¨ã§ã™ã€‚
        </div>
        <div class="sep"></div>

        <div class="grid">
          <div class="card" style="background:rgba(255,255,255,.03)">
            <h2 style="font-size:16px;margin-bottom:6px">â‘  è·å ´ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¿å­˜ã•ã‚Œã¾ã™ï¼‰</h2>
            <div class="grid">
              <div>
                <label>çµ„ç¹”åï¼ˆä»»æ„ï¼‰</label>
                <input id="wpOrg" placeholder="ä¾‹ï¼šã€‡ã€‡æ ªå¼ä¼šç¤¾ï¼ˆä»»æ„ï¼‰" value="${esc(state.workProfile.orgName)}">
              </div>
              <div class="row" style="gap:10px">
                <div style="flex:1;min-width:200px">
                  <label>æ¥­ç¨®</label>
                  <select id="wpIndustry">
                    <option value="">ï¼ˆé¸æŠï¼‰</option>
                    ${INDUSTRIES.map(x=>`<option value="${esc(x)}" ${state.workProfile.industry===x?'selected':''}>${esc(x)}</option>`).join('')}
                  </select>
                </div>
                <div style="flex:1;min-width:200px">
                  <label>è·ç¨®</label>
                  <select id="wpJob">
                    <option value="">ï¼ˆé¸æŠï¼‰</option>
                    ${JOB_FUNCTIONS.map(x=>`<option value="${esc(x)}" ${state.workProfile.jobFunction===x?'selected':''}>${esc(x)}</option>`).join('')}
                  </select>
                </div>
              </div>
              <div class="row" style="gap:10px">
                <div style="flex:1;min-width:200px">
                  <label>éƒ¨ç½²ï¼ˆä»»æ„ï¼‰</label>
                  <input id="wpDept" placeholder="ä¾‹ï¼šå–¶æ¥­éƒ¨/é–‹ç™ºéƒ¨â€¦" value="${esc(state.workProfile.department)}">
                </div>
                <div style="flex:1;min-width:200px">
                  <label>å½¹å‰²ï¼ˆä»»æ„ï¼‰</label>
                  <input id="wpRole" placeholder="ä¾‹ï¼šãƒªãƒ¼ãƒ€ãƒ¼/æ‹…å½“â€¦" value="${esc(state.workProfile.role)}">
                </div>
              </div>

              <div>
                <label>åˆ©ç”¨è€…åŒºåˆ†ï¼ˆè¨“ç·´ãƒ¢ãƒ¼ãƒ‰ï¼‰</label>
                <div class="row" style="gap:10px;flex-wrap:wrap">
                  <span class="chip ${state.workProfile.userTier==='auto'?'active':''}" data-user-tier="auto">è‡ªå‹•ï¼ˆå½¹å‰²ã‹ã‚‰æ¨å®šï¼‰</span>
                  <span class="chip ${state.workProfile.userTier==='general'?'active':''}" data-user-tier="general">ä¸€èˆ¬</span>
                  <span class="chip ${state.workProfile.userTier==='manager'?'active':''}" data-user-tier="manager">ç®¡ç†è€…</span>
                  <span class="chip ${state.workProfile.userTier==='executive'?'active':''}" data-user-tier="executive">å½¹è·è€…</span>
                </div>
                <div class="muted" style="margin-top:6px">
                  ç¾åœ¨ã®é©ç”¨ï¼š<b>${esc(userTierLabel(resolveUserTier()))}</b>
                  ${state.workProfile.userTier==='auto' ? `<span class="muted">ï¼ˆå½¹å‰²ï¼š${esc(state.workProfile.role||'æœªå…¥åŠ›')} ã‹ã‚‰æ¨å®šï¼‰</span>` : ''}
                </div>
              </div>

              <div class="row" style="justify-content:space-between;align-items:flex-end">
                <div style="flex:1;min-width:240px">
                  <label>KPIï¼ˆ1è¡Œ1é …ç›®ãƒ»ç·¨é›†å¯ï¼‰</label>
                  <textarea id="wpKpi" rows="4" placeholder="ä¾‹ï¼šå£²ä¸Š\nå—æ³¨ç‡\nCSATâ€¦">${esc(state.workProfile.kpiText)}</textarea>
                </div>
                <div style="flex:1;min-width:240px">
                  <label>ä¸»è¦ãƒªã‚¹ã‚¯ï¼ˆ1è¡Œ1é …ç›®ãƒ»ç·¨é›†å¯ï¼‰</label>
                  <textarea id="wpRisk" rows="4" placeholder="ä¾‹ï¼šç‚ä¸Š\næƒ…å ±æ¼ãˆã„\néåŠ´â€¦">${esc(state.workProfile.riskText)}</textarea>
                </div>
              </div>

              <div class="row">
                <button class="btn green" id="wpSuggest">æ¥­ç¨®Ã—è·ç¨®ã‹ã‚‰KPI/ãƒªã‚¹ã‚¯ã‚’è‡ªå‹•ææ¡ˆ</button>
                <button class="btn primary" id="wpSaveProfile">ä¿å­˜</button>
              </div>

              <div class="notice">
                <b>ãƒã‚¤ãƒ³ãƒˆï¼š</b>ã“ã“ã§å‡ºã—ãŸKPI/ãƒªã‚¹ã‚¯ã¯â€œç‚¹æ•°â€ã§ã¯ãªãã€<b>æ„å‘³ï¼ˆå®ˆã‚‹å¯¾è±¡ï¼‰ã‚’æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã®ç´ æ</b>ã§ã™ã€‚
              </div>
            </div>
          </div>

          <div class="card" style="background:rgba(255,255,255,.03)">
            <h2 style="font-size:16px;margin-bottom:6px">â‘¡ ä»Šæ—¥ã®è·å ´ãƒ­ã‚°ï¼ˆKPIã‚’æ„å‘³ã¸ç¿»è¨³ã—ã¦å›ã™ï¼‰</h2>

            <form data-workplace data-work="æ—¥æ¬¡è·å ´ãƒ­ã‚°">
              <div class="grid">
                <div>
                  <label>æ—¥ä»˜</label>
                  <input type="date" name="æ—¥ä»˜" value="${today}">
                </div>
                <div>
                  <label>çŠ¶æ³ï¼ˆå¤–å´ã§èµ·ãã¦ã„ã‚‹ã“ã¨ï¼‰</label>
                  <input name="çŠ¶æ³" placeholder="ä¾‹ï¼šå•†è«‡ãŒé›£èˆªï¼ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œï¼ç· ã‚ä½œæ¥­â€¦" />
                </div>
              </div>

              <div class="sep"></div>

              <div class="notice">
                <b>ï¼ˆ1ï¼‰KPI â†’ æ„å‘³ã¸ã®ç¿»è¨³</b><br/>
                ã€Œã“ã®KPIã‚’å®ˆã‚‹ã“ã¨ã¯ã€èª°ã®ä½•ã‚’å®ˆã‚‹ã“ã¨ï¼Ÿã€<br/>
                ä¾‹ï¼šå£²ä¸Šï¼é¡§å®¢ã®å•é¡Œè§£æ±ºï¼é›‡ç”¨ã®ç¶­æŒï¼ãƒãƒ¼ãƒ ã®èª‡ã‚Š
              </div>
              <label>ä»Šæ—¥å‘ãåˆã£ãŸKPI/æœŸå¾…ï¼ˆä»»æ„ï¼‰</label>
              <input name="KPI/æœŸå¾…" placeholder="ä¾‹ï¼šå—æ³¨ç‡ã€CSATã€å“è³ªã€ä¸è‰¯ç‡ã€ç´æœŸâ€¦">
              <label>ãã®KPIãŒâ€œå®ˆã£ã¦ã„ã‚‹å¯¾è±¡ï¼ˆä¾¡å€¤ï¼‰â€ã¯ï¼Ÿ</label>
              <textarea name="å®ˆã‚‹å¯¾è±¡ï¼ˆä¾¡å€¤ï¼‰" rows="2" placeholder="ä¾‹ï¼šé¡§å®¢ã®å®‰å¿ƒï¼å®‰å…¨ï¼ä¿¡é ¼ï¼å°Šå³â€¦"></textarea>

              <div class="sep"></div>

              <div class="notice">
                <b>ï¼ˆ2ï¼‰ãƒªã‚¹ã‚¯ â†’ å¢ƒç•Œç·šï¼ˆå®‰å…¨è£…ç½®ï¼‰</b><br/>
                ã€Œå…†å€™ãŒå‡ºãŸã‚‰â€œæ­¢ã¾ã‚‹ãƒ»ç›¸è«‡ã™ã‚‹â€ãŒæ­£è§£ã€ã‚‚å«ã‚ã¦é‹ç”¨ã—ã¾ã™ã€‚
              </div>
              <label>ä»Šæ—¥æ°—ã«ãªã£ãŸãƒªã‚¹ã‚¯/å…†å€™ï¼ˆä»»æ„ï¼‰</label>
              <textarea name="ãƒªã‚¹ã‚¯/å…†å€™" rows="2" placeholder="ä¾‹ï¼šç„¦ã‚Šã§é›‘ã«ãªã‚‹ï¼æ„Ÿæƒ…ãŒè’ã‚Œã‚‹ï¼ç–²åŠ´ãŒå¼·ã„â€¦"></textarea>
              <label>ä¸­æ­¢ã‚µã‚¤ãƒ³ï¼ˆä½“ãƒ»å¿ƒï¼‰</label>
              <input name="ä¸­æ­¢ã‚µã‚¤ãƒ³" placeholder="ä¾‹ï¼šå‹•æ‚¸ã€æ¶™ãŒæ­¢ã¾ã‚‰ãªã„ã€åˆ¤æ–­ãŒè’ã„â€¦">

              <div class="sep"></div>

              <div class="notice">
                <b>ï¼ˆ3ï¼‰ä¸‰å¤§è¨“ç·´ã®â€œè·å ´ç‰ˆâ€</b><br/>
                è‡ªå·±è¶…è¶Šï¼ˆèª°ã®ãŸã‚ã«ï¼‰ï¼æ„å‘³ç™ºè¦‹ï¼ˆå­¦ã³ï¼‰ï¼æ…‹åº¦ä¾¡å€¤ï¼ˆã©ã†åœ¨ã‚‹ã‹ï¼‰
              </div>
              <label>è‡ªå·±è¶…è¶Šï¼šä»Šæ—¥ã¯èª°/ä½•ã®ãŸã‚ã«åƒãï¼Ÿ</label>
              <textarea name="è‡ªå·±è¶…è¶Šï¼ˆå¯¾è±¡ï¼‰" rows="2"></textarea>
              <label>æ„å‘³ç™ºè¦‹ï¼šä»Šæ—¥ã®çµŒé¨“ã‹ã‚‰ã®å­¦ã³ï¼ˆæ„å‘³ï¼‰</label>
              <textarea name="æ„å‘³ï¼ˆå­¦ã³ï¼‰" rows="2"></textarea>
              <label>æ…‹åº¦ä¾¡å€¤ï¼šé¿ã‘ã‚‰ã‚Œãªã„åˆ¶ç´„ã®ä¸­ã§ã€ã©ã‚“ãªæ…‹åº¦ã‚’é¸ã¶ï¼Ÿ</label>
              <textarea name="æ…‹åº¦ï¼ˆé¸æŠï¼‰" rows="2"></textarea>

              <div class="sep"></div>

              <div class="notice"><b>ï¼ˆ4ï¼‰æ¬¡ã®ä¸€æ‰‹ï¼š1%è¡Œå‹• +ï¼ˆä»»æ„ã§ï¼‰50%ãƒãƒ£ãƒ¬ãƒ³ã‚¸</b></div>
              <label>1%è¡Œå‹•ï¼ˆæœ€å°ãƒ»å®‰å…¨ãƒ»ç¢ºå®Ÿï¼‰</label>
              <input name="1%è¡Œå‹•" placeholder="ä¾‹ï¼šè¿”ä¿¡ã‚’ä¸å¯§ã«1é€šï¼æ•´ç†2åˆ†ï¼ç›¸è«‡ãƒ¡ãƒ¢â€¦">
              <label>50%ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆä»»æ„ï¼‰</label>
              <input name="50%ãƒãƒ£ãƒ¬ãƒ³ã‚¸" placeholder="ä¾‹ï¼šææ¡ˆã‚’1ã¤å‡ºã™ï¼ç›¸è«‡ã™ã‚‹ï¼æ–­ã‚‹â€¦">
              <label>äº‹å¾Œçš„è‡ªç”±ï¼šã“ã®è¡Œå‹•ã§ç­‹åŠ›ã¯ã©ã†é›ãˆã‚‰ã‚ŒãŸï¼Ÿ</label>
              <textarea name="äº‹å¾Œçš„è‡ªç”±ï¼ˆå†è§£é‡ˆï¼‰" rows="2"></textarea>

              <div class="sep"></div>

              <button class="btn primary" type="submit">ğŸ“’ æ—¥èªŒã«è¨˜éŒ²ï¼ˆè·å ´ãƒ­ã‚°ï¼‰</button>
            </form>

            <div class="sep"></div>
            <div class="muted">
              <b>å‚è€ƒï¼š</b>ç¾åœ¨ã®ææ¡ˆKPI/ãƒªã‚¹ã‚¯ï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœªè¨­å®šãªã‚‰ç©ºã§ã™ï¼‰<br/>
              KPIï¼š<span class="badge" id="wpKpiPreview">â€”</span><br/>
              ãƒªã‚¹ã‚¯ï¼š<span class="badge" id="wpRiskPreview">â€”</span>
            </div>
          </div>

          <details class="card">
            <summary><b>â‘¢ åˆ©ç”¨è€…åŒºåˆ†ï¼ˆä¸€èˆ¬/ç®¡ç†è€…/å½¹è·è€…ï¼‰åˆ¥ Q&amp;A</b></summary>
            <div class="sep"></div>
            <div class="muted">
              ç¾åœ¨ã®é©ç”¨ï¼š<b>${esc(userTierLabel(resolveUserTier()))}</b>
              ${state.workProfile.userTier==='auto' ? `<span class="muted">ï¼ˆå½¹å‰²ï¼š${esc(state.workProfile.role||'æœªå…¥åŠ›')} ã‹ã‚‰æ¨å®šï¼‰</span>` : ''}
            </div>
            <div class="sep"></div>
            <div class="grid">
              ${renderTierFaqHtml()}
            </div>
          </details>

          <details class="card">
            <summary><b>â‘£ è·ç¨®åˆ¥Q&amp;Aï¼ˆè·å ´ç‰ˆï¼‰</b></summary>
            <div class="sep"></div>
            <div class="muted">
              å½¹è·è€…ãƒ»å°‚é–€è·å‘ã‘ã§ã‚‚ã€<b>ã€Œè©•ä¾¡ã«ä½¿ã‚ãªã„ã€ã€Œå¿ƒèº«ã®å®‰å…¨ã€</b>ã ã‘ã¯æ˜æ–‡åŒ–ã—ã¦ãŠãã¨å°å…¥ãŒæ»‘ã‚‰ã‹ã§ã™ã€‚
            </div>
            <div class="sep"></div>
            <div class="grid">
              <div class="card" style="background:rgba(255,255,255,.03)">
                <b>Q. ã“ã‚Œã€æ¥­ç¸¾è©•ä¾¡ã®ææ–™ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ</b><br/>
                <span class="muted">A. åŸå‰‡ã—ã¾ã›ã‚“ã€‚ã“ã“ã¯â€œæ„å‘³ã¨æ…‹åº¦â€ã®è¨“ç·´ãƒ­ã‚°ã§ã‚ã‚Šã€è©•ä¾¡ã¯åˆ¥ç³»çµ±ã§æ‰±ã†ã®ãŒå®‰å…¨ã§ã™ã€‚</span>
              </div>
              <div class="card" style="background:rgba(255,255,255,.03)">
                <b>Q. KPIãŒå¼·ã„ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã«ãªã‚Šã¾ã™ã€‚</b><br/>
                <span class="muted">A. KPIã‚’â€œç‚¹æ•°â€ã¨ã—ã¦æ¡ã‚Šã—ã‚ãšã€ã€Œèª°ã®ä½•ã‚’å®ˆã‚‹ãŸã‚ã‹ã€ã¸ç¿»è¨³ã—ã¦è² è·ã‚’ä¸‹ã’ã¾ã™ã€‚å¿…è¦ãªã‚‰ä¸Šå¸/ç”£æ¥­ä¿å¥ã¸ç›¸è«‡ã€‚</span>
              </div>
              <div class="card" style="background:rgba(255,255,255,.03)">
                <b>Q. ãƒªã‚¹ã‚¯ã°ã‹ã‚Šè€ƒãˆã¦ä¸å®‰ã«ãªã‚Šã¾ã™ã€‚</b><br/>
                <span class="muted">A. ãƒªã‚¹ã‚¯ã¯ææ€–ã§ã¯ãªãâ€œå¢ƒç•Œç·šâ€ã€‚ä¸­æ­¢ã‚µã‚¤ãƒ³ãŒå‡ºãŸã‚‰æ­¢ã¾ã‚‹ã€ãŒæ­£è§£ã§ã™ã€‚</span>
              </div>
              <div class="card" style="background:rgba(255,255,255,.03)">
                <b>Q. å¿™ã—ãã¦å…¥åŠ›ã§ãã¾ã›ã‚“ã€‚</b><br/>
                <span class="muted">A. 1åˆ†ã§OKã€‚ã€ŒçŠ¶æ³â†’1%è¡Œå‹•ã€ã ã‘ã§ã‚‚å›ã‚Œã°ååˆ†ã§ã™ã€‚</span>
              </div>
            </div>
          </details>
        </div>
      </details>



      <details class="card">
        <summary><b>ç„¡ç†ã‚’ã—ãªã„ãŸã‚ã®Q&amp;Aï¼ˆæŠœç²‹ï¼‰</b></summary>
        <div class="sep"></div>
        <div class="muted">
          ãƒ»å…¨éƒ¨ã‚„ã‚‰ãªãã¦OKã€‚ã€Œã“ã‚Œãªã‚‰ã‚„ã‚Œãã†ã€ã‚’1ã¤ã ã‘ã€‚<br>
          ãƒ»ã—ã‚“ã©ããªã£ãŸã‚‰ã€æ·±å‘¼å¸ã—ã¦ã„ã£ãŸã‚“ä¸­æ–­ã€‚ã€Œä»Šæ—¥ã¯ã“ã“ã¾ã§ã€ã‚‚è¨“ç·´ã€‚<br>
          ãƒ»æ²»ç™‚ä¸­ã®å ´åˆã¯ã€ä¸»æ²»åŒ»/ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ã«ç›¸è«‡ã—ã¦ã‹ã‚‰ã€‚<br>
        </div>
      </details>
    `;
  }

function render() {
    if (state.tab === 'home') view.innerHTML = renderHome();
    if (state.tab === 'engine') view.innerHTML = renderEngine();
    if (state.tab === 'history') view.innerHTML = renderHistory();
    if (state.tab === 'training') view.innerHTML = renderTraining();
    if (state.tab === 'theory') view.innerHTML = renderTheory();

    wire();
  }

  function wire(){
    // global tabs
    $$('.tab').forEach(b => b.onclick = () => setTab(b.dataset.tab));

    // home handlers
    const startEngine = $('#startEngine');
    if (startEngine) startEngine.onclick = () => { setTab('engine'); };
    const goHistory = $('#goHistory');
    if (goHistory) goHistory.onclick = () => setTab('history');

    // mode chips home
    $$('[data-mode]').forEach(ch => ch.onclick = () => {
      const m = ch.dataset.mode;
      state.mode = m;
      state.draft.mode = m;
      persistDraft();
      render();
    });

    // engine handlers
    $$('[data-step]').forEach(b => b.onclick = () => setStep(Number(b.dataset.step)));

    const prev = $('#prevStep');
    if (prev) prev.onclick = () => setStep(state.step - 1);

    const next = $('#nextStep');
    if (next) next.onclick = () => setStep(state.step + 1);

    const reset = $('#resetDraft');
    if (reset) reset.onclick = () => { if(confirm('å…¥åŠ›ä¸­ã®å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) resetDraft(); render(); };

    const okReady = $('#okReady');
    if (okReady) okReady.onclick = () => setStep(1);

    const fillNow = $('#fillNow');
    if (fillNow) fillNow.onclick = () => { state.draft.date = nowJP(); persistDraft(); render(); };

    $$('[data-mode2]').forEach(ch => ch.onclick = () => {
      const m = ch.dataset.mode2;
      state.mode = m;
      state.draft.mode = m;
      persistDraft(); render();
    });

    const dateInput = $('#dateInput');
    if (dateInput) dateInput.oninput = (e) => { state.draft.date = e.target.value; persistDraft(); };

    const ext = $('#ext');
    if (ext) ext.oninput = (e) => { state.draft.externalFeedback = e.target.value; persistDraft(); };

    const ref = $('#ref');
    if (ref) ref.oninput = (e) => { state.draft.reflection = e.target.value; persistDraft(); };

    $$('[data-wind]').forEach(ch => ch.onclick = () => {
      state.draft.windType = ch.dataset.wind;
      persistDraft(); render();
    });

    const wf = $('#windForce');
    if (wf) wf.oninput = (e) => { state.draft.windForce = Number(e.target.value); persistDraft(); render(); };

    $$('[data-q]').forEach(ch => ch.onclick = async () => {
      const q = ch.dataset.q || '';
      try { await navigator.clipboard.writeText(q); alert('è³ªå•ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
      catch { alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚'); }
    });

    const comp = $('#comp');
    if (comp) comp.oninput = (e) => { state.draft.compass = e.target.value; persistDraft(); };

    const act = $('#act');
    if (act) act.oninput = (e) => { state.draft.action1Percent = e.target.value; persistDraft(); };

    const copyAction = $('#copyAction');
    if (copyAction) copyAction.onclick = async () => {
      const t = state.draft.action1Percent || '';
      try { await navigator.clipboard.writeText(t); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
      catch { alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚'); }
    };

    const infb = $('#infb');
    if (infb) infb.oninput = (e) => { state.draft.internalFeedback = e.target.value; persistDraft(); };

    const nextTxt = $('#next');
    if (nextTxt) nextTxt.oninput = (e) => { state.draft.nextStep = e.target.value; persistDraft(); };

    const save = $('#saveLog');
    if (save) save.onclick = saveLog;

    // history
    const startFromHistory = $('#startFromHistory');
    if (startFromHistory) startFromHistory.onclick = () => setTab('engine');

    const newEntry = $('#newEntry');
    if (newEntry) newEntry.onclick = () => { setTab('engine'); };

    const delAll = $('#deleteAll');
    if (delAll) delAll.onclick = deleteAllLogs;

    const exp = $('#export');
    if (exp) exp.onclick = exportLogs;

    const imp = $('#import');
    if (imp) imp.onchange = (e) => {
      const f = e.target.files && e.target.files[0];
      if (f) importLogs(f);
      e.target.value = '';
    };


    // training handlers
    // workplace profile (è·å ´å‘ã‘ï¼šå€‹äººç”¨)
    const wpOrg = $('#wpOrg');
    if (wpOrg) wpOrg.oninput = (e) => { state.workProfile.orgName = e.target.value; persistProfile(); };

    const wpIndustry = $('#wpIndustry');
    if (wpIndustry) wpIndustry.onchange = (e) => { state.workProfile.industry = e.target.value; persistProfile(); render(); };

    const wpJob = $('#wpJob');
    if (wpJob) wpJob.onchange = (e) => { state.workProfile.jobFunction = e.target.value; persistProfile(); render(); };

    const wpDept = $('#wpDept');
    if (wpDept) wpDept.oninput = (e) => { state.workProfile.department = e.target.value; persistProfile(); };

    const wpRole = $('#wpRole');
    if (wpRole) wpRole.oninput = (e) => { state.workProfile.role = e.target.value; persistProfile(); };

    // åˆ©ç”¨è€…åŒºåˆ†ï¼ˆè¨“ç·´ãƒ¢ãƒ¼ãƒ‰ï¼‰
    $$('[data-user-tier]').forEach(el => {
      el.onclick = () => {
        const t = el.getAttribute('data-user-tier') || 'auto';
        state.workProfile.userTier = t;
        persistProfile();
        render();
      };
    });

    const wpKpi = $('#wpKpi');
    if (wpKpi) wpKpi.oninput = (e) => { state.workProfile.kpiText = e.target.value; persistProfile(); };

    const wpRisk = $('#wpRisk');
    if (wpRisk) wpRisk.oninput = (e) => { state.workProfile.riskText = e.target.value; persistProfile(); };

    const wpSuggest = $('#wpSuggest');
    if (wpSuggest) wpSuggest.onclick = () => {
      const d = deriveKpiRisk(state.workProfile.industry, state.workProfile.jobFunction);
      state.workProfile.kpiText = d.kpis.join('\n');
      state.workProfile.riskText = d.risks.join('\n');
      persistProfile();
      render();
    };

    const wpSaveProfile = $('#wpSaveProfile');
    if (wpSaveProfile) wpSaveProfile.onclick = () => { persistProfile(); alert('è·å ´ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚'); };

    // preview chips
    const wpKpiPreview = $('#wpKpiPreview');
    const wpRiskPreview = $('#wpRiskPreview');
    if (wpKpiPreview || wpRiskPreview) {
      const k = (state.workProfile.kpiText||'').split(/\n+/).map(s=>s.trim()).filter(Boolean).slice(0,6);
      const r = (state.workProfile.riskText||'').split(/\n+/).map(s=>s.trim()).filter(Boolean).slice(0,6);
      if (wpKpiPreview) wpKpiPreview.textContent = k.length ? k.join(' / ') : 'â€”';
      if (wpRiskPreview) wpRiskPreview.textContent = r.length ? r.join(' / ') : 'â€”';
    }

    // workplace daily log
    $$('form[data-workplace]').forEach(f => {
      f.onsubmit = (e) => {
        e.preventDefault();
        const data = {};
        Array.from(f.elements).forEach(el => {
          if (!el || !el.name) return;
          data[el.name] = (el.value || '').trim();
        });
        // è¨“ç·´ãƒ¢ãƒ¼ãƒ‰ï¼ˆåˆ©ç”¨è€…åŒºåˆ†ï¼‰ã¨è·å ´ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»˜ä¸ï¼ˆãƒ­ã‚°ã®å†ç¾æ€§ã‚’é«˜ã‚ã‚‹ï¼‰
        const effTier = resolveUserTier();
        data['åˆ©ç”¨è€…åŒºåˆ†'] = userTierLabel(effTier) + (state.workProfile.userTier === 'auto' ? 'ï¼ˆè‡ªå‹•ï¼‰' : '');
        if (state.workProfile.industry) data['è·å ´ï¼šæ¥­ç¨®'] = state.workProfile.industry;
        if (state.workProfile.department) data['è·å ´ï¼šéƒ¨ç½²'] = state.workProfile.department;
        if (state.workProfile.role) data['è·å ´ï¼šå½¹å‰²'] = state.workProfile.role;
        if (state.workProfile.jobFunction) data['è·å ´ï¼šè·ç¨®'] = state.workProfile.jobFunction;

        const id = String(Date.now());
        const lines = Object.keys(data).filter(k => data[k]).map(k => `${k}ï¼š${data[k]}`);
        const summary = data['1%è¡Œå‹•'] || data['çŠ¶æ³'] || lines[0] || '';
        const entry = {
          id,
          type: 'workplace',
          date: nowJP(),
          work: f.dataset.work || 'è·å ´ãƒ­ã‚°',
          orgName: state.workProfile.orgName || '',
          industry: state.workProfile.industry || '',
          department: state.workProfile.department || '',
          role: state.workProfile.role || '',
          jobFunction: state.workProfile.jobFunction || '',
          kpis: (state.workProfile.kpiText||'').split(/\n+/).map(s=>s.trim()).filter(Boolean),
          risks: (state.workProfile.riskText||'').split(/\n+/).map(s=>s.trim()).filter(Boolean),
          summary,
          body: [
            `ã€è·å ´ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€‘`,
            `çµ„ç¹”åï¼š${state.workProfile.orgName||'â€”'}`,
            `æ¥­ç¨®ï¼š${state.workProfile.industry||'â€”'}`,
            `è·ç¨®ï¼š${state.workProfile.jobFunction||'â€”'}`,
            `éƒ¨ç½²ï¼š${state.workProfile.department||'â€”'} / å½¹å‰²ï¼š${state.workProfile.role||'â€”'}`,
            `KPIï¼š${((state.workProfile.kpiText||'').split(/\n+/).map(s=>s.trim()).filter(Boolean).slice(0,8)).join(' / ') || 'â€”'}`,
            `ãƒªã‚¹ã‚¯ï¼š${((state.workProfile.riskText||'').split(/\n+/).map(s=>s.trim()).filter(Boolean).slice(0,8)).join(' / ') || 'â€”'}`,
            ``,
            `ã€ä»Šæ—¥ã®ãƒ­ã‚°ã€‘`,
            ...lines
          ].join('\n'),
          data
        };
        state.logs.unshift(entry);
        persist();
        alert('è·å ´ãƒ­ã‚°ã‚’æ—¥èªŒã«è¨˜éŒ²ã—ã¾ã—ãŸã€‚');
        setTab('history');
      };
    });

    $$('form[data-training]').forEach(f => {
      f.onsubmit = (e) => {
        e.preventDefault();
        const pillar = f.dataset.pillar || '';
        const work = f.dataset.work || '';
        const data = {};
        Array.from(f.elements).forEach(el => {
          if (!el || !el.name) return;
          data[el.name] = (el.value || '').trim();
        });
        // è¨“ç·´ãƒ¢ãƒ¼ãƒ‰ï¼ˆåˆ©ç”¨è€…åŒºåˆ†ï¼‰ã¨è·å ´ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»˜ä¸ï¼ˆãƒ­ã‚°ã®å†ç¾æ€§ã‚’é«˜ã‚ã‚‹ï¼‰
        const effTier = resolveUserTier();
        data['åˆ©ç”¨è€…åŒºåˆ†'] = userTierLabel(effTier) + (state.workProfile.userTier === 'auto' ? 'ï¼ˆè‡ªå‹•ï¼‰' : '');
        if (state.workProfile.orgName) data['è·å ´ï¼šä¼šç¤¾'] = state.workProfile.orgName;
        if (state.workProfile.industry) data['è·å ´ï¼šæ¥­ç¨®'] = state.workProfile.industry;
        if (state.workProfile.department) data['è·å ´ï¼šéƒ¨ç½²'] = state.workProfile.department;
        if (state.workProfile.role) data['è·å ´ï¼šå½¹å‰²'] = state.workProfile.role;
        if (state.workProfile.jobFunction) data['è·å ´ï¼šè·ç¨®'] = state.workProfile.jobFunction;

        const id = String(Date.now());
        const lines = Object.keys(data).filter(k => data[k]).map(k => `${k}ï¼š${data[k]}`);
        const entry = {
          id,
          type: 'training',
          date: nowJP(),
          pillar,
          work,
          summary: lines[0] || '',
          body: lines.join('\n'),
          data
        };
        state.logs.unshift(entry);
        persist();
        alert('è¨“ç·´ã‚’æ—¥èªŒã«è¨˜éŒ²ã—ã¾ã—ãŸã€‚');
        setTab('history');
      };
    });

    $$('[data-del]').forEach(b => b.onclick = () => deleteLog(b.dataset.del));
  }

  // init
  load();
  // set draft mode if missing
  if (!state.draft.mode) state.draft.mode = state.mode;
  // default date fill
  if (!state.draft.date) state.draft.date = '';
  render();

})();
</script>

<script>
(() => {
  const banner = document.getElementById('installBanner');
  const installBtn = document.getElementById('installBtn');
  const helpBtn = document.getElementById('installHelpBtn');
  const closeBtn = document.getElementById('installCloseBtn');
  const msgEl = document.getElementById('installMsg');

  // --- Service Worker registration (required for "installable" PWA on Android/Chrome)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        await navigator.serviceWorker.register('./sw.js', { scope: './' });
        // console.log('SW registered');
      } catch (e) {
        // console.warn('SW failed', e);
      }
    });
  }

  // --- Install prompt (Chrome/Edge/Android)
  let deferredPrompt = null;

  function isStandalone() {
    return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
  }

  function showBanner(text, canInstall) {
    if (!banner || isStandalone()) return;
    banner.classList.remove('hidden');
    if (text) msgEl.textContent = text;
    installBtn.style.display = canInstall ? 'inline-block' : 'none';
  }

  function hideBanner() {
    if (!banner) return;
    banner.classList.add('hidden');
  }

  // iOS (Safari): no beforeinstallprompt
  function isiOS() {
    return /iphone|ipad|ipod/i.test(navigator.userAgent);
  }
  function isSafari() {
    return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  }

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    showBanner('ğŸ“² ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã§ãã¾ã™ï¼ˆã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«èµ·å‹•ï¼‰', true);
  });

  window.addEventListener('appinstalled', () => {
    deferredPrompt = null;
    hideBanner();
  });

  if (helpBtn) helpBtn.addEventListener('click', () => {
    if (isiOS() && isSafari()) {
      alert('iPhone/iPadï¼ˆSafariï¼‰:
1) å…±æœ‰ãƒœã‚¿ãƒ³ï¼ˆâ–¡â†‘ï¼‰
2)ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€
3) è¿½åŠ 

â€»iOSã¯ã€Œã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ãƒœã‚¿ãƒ³ãŒå‡ºã¾ã›ã‚“ã€‚');
    } else {
      alert('Androidï¼ˆChrome/Edgeï¼‰:
1) å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆï¸™ï¼‰
2)ã€Œã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã¾ãŸã¯ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€
3) è¿½åŠ 

â€»ã“ã®ãƒšãƒ¼ã‚¸ã¯HTTPSã§é–‹ãå¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆlocalhosté™¤ãï¼‰ã€‚');
    }
  });

  if (installBtn) installBtn.addEventListener('click', async () => {
    try {
      if (!deferredPrompt) {
        showBanner('â€»ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã€Œã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ãƒœã‚¿ãƒ³ãŒå‡ºã¾ã›ã‚“ã€‚å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚', false);
        return;
      }
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      deferredPrompt = null;
      if (choice && choice.outcome !== 'accepted') {
        // user dismissed
      } else {
        hideBanner();
      }
    } catch (e) {
      // ignore
    }
  });

  if (closeBtn) closeBtn.addEventListener('click', hideBanner);

  // Initial banner hint for iOS (Safari)
  setTimeout(() => {
    if (isStandalone()) return;
    if (isiOS() && isSafari()) {
      showBanner('ğŸ“² iPhone/iPadã¯ã€Œå…±æœ‰ã€â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã§ã‚¢ãƒ—ãƒªåŒ–ã§ãã¾ã™', false);
    }
  }, 1200);

})();
</script>
</body>
</html>
